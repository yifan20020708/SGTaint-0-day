# Buffer Overflow Vulnerability in `/proc/net/arp`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | Cisco Linksys E1200 v2 Router                                |
| Firmware Version     | **E1200_v2.0.11.001_us.tar.gz**                              |
| Vulnerability Type   | **Stack-Based Buffer Overflow**                              |
| Vulnerable Component | `libshared.so` (functions `get_mac_from_ip` & `get_ip_from_mac`, buffers `v6`, `v7`) |
| Prerequisites        | Requires control over `/proc/net/arp` content or filesystem write permissions (local exploitation only) |

2. Exploitation Path

```c
char *__fastcall get_mac_from_ip(const char *a1)
{
  FILE *v1; // $v0
  FILE *v2; // $s1
  char v4; // [sp+28h] [-138h] BYREF
  char v5; // [sp+2Ch] [-134h] BYREF
  char v6[50]; // [sp+30h] [-130h] BYREF
  char v7[150]; // [sp+62h] [-FEh] BYREF
  char v8[104]; // [sp+F8h] [-68h] BYREF

  v1 = fopen("/proc/net/arp", "r");
  v2 = v1;
  if ( !v1 )
    return 0;
  if ( fgets(v8, 100, v1) )
  {
    while ( fgets(v8, 100, v2) )
    {
      if ( sscanf(v8, "%s 0x%x 0x%x %100s %100s %100s\n", 
                  v6, &v4, &v5, v7, &v7[50], &v7[100]) == 6 && !strcmp(a1, v6) )
      {
        strcpy(mac_7685, v7);
        fclose(v2);
        return mac_7685;
      }
    }
  }
  fclose(v2);
  return &byte_71F1C;
}

char *__fastcall get_ip_from_mac(const char *a1)
{
  FILE *v1; // $v0
  FILE *v2; // $s1
  char v4; // [sp+28h] [-138h] BYREF
  char v5; // [sp+2Ch] [-134h] BYREF
  char v6[50]; // [sp+30h] [-130h] BYREF
  char v7[150]; // [sp+62h] [-FEh] BYREF
  char v8[104]; // [sp+F8h] [-68h] BYREF

  v1 = fopen("/proc/net/arp", "r");
  v2 = v1;
  if ( !v1 )
    return 0;
  if ( fgets(v8, 100, v1) )
  {
    while ( fgets(v8, 100, v2) )
    {
      if ( sscanf(v8, "%s 0x%x 0x%x %100s %100s %100s\n", 
                  v6, &v4, &v5, v7, &v7[50], &v7[100]) == 6 && !strcmp(a1, v7) )
      {
        strcpy(ip_7706, v6);
        fclose(v2);
        return ip_7706;
      }
    }
  }
  fclose(v2);
  return &byte_71F1C;
}
```

3. **Vulnerable Binaries:** `libshared.so`.
4. 0-Day Command Injection Exploitation Path:
   - In the `httpd` file, at line 17, `fgets(v8, 100, v2)` reads data from the `/proc/net/arp` file. At line 19, `sscanf(v8, "%s 0x%x 0x%x %100s %100s %100s\n", v6, &v4, &v5, v7, &v7[50], &v7[100])` parses the string. The buffer `v6` has no length restriction, and `&v7[50]` is limited to 50 bytes but may read up to 100 bytes, both leading to buffer overflow vulnerabilities.
   - In the `httpd` file, at line 48, `fgets(v8, 100, v2)` reads data from the `/proc/net/arp` file. At line 50, `sscanf(v8, "%s 0x%x 0x%x %100s %100s %100s\n", v6, &v4, &v5, v7, &v7[50], &v7[100])` parses the string. The buffer `v6` has no length restriction, and `&v7[50]` is limited to 50 bytes but may read up to 100 bytes, both leading to buffer overflow vulnerabilities.
5. Proof of Concept (PoC) for Reproducing the Vulnerability

```bash
echo -e "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA 0x1 0x2 BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB 0x0 0x0" > /tmp/fake_arp
mount --bind /tmp/fake_arp /proc/net/arp
```
